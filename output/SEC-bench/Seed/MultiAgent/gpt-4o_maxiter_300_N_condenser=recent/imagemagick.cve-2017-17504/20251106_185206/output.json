{
  "instance_id": "imagemagick.cve-2017-17504",
  "instruction": "\nPlease coordinate the vulnerability reproduction process for the following instance:\n```json\n{\n  \"instance_id\": \"imagemagick.cve-2017-17504\",\n  \"repo\": \"imagemagick/imagemagick\",\n  \"base_commit\": \"4b484c9ca35c78a828c3ca6a8d077ac1ce3fdecb\",\n  \"work_dir\": \"/src/imagemagick\",\n  \"build_sh\": \"#!/bin/bash -eu\\n# Minimized build script with only core build commands\\nset -eu\\n./configure --prefix=\\\"$WORK\\\" --disable-shared --disable-docs\\nmake \\\"-j$(nproc)\\\"\\nmake install -j$(nproc)\",\n  \"bug_description\": \"================= Bug Report (1/1) ==================\\n## Source: GitHub Issue\\n## URL: https://github.com/ImageMagick/ImageMagick/issues/872\\n## Description:\\nIssue: ImageMagick/ImageMagick#872\\nTitle: heap-buffer-overflow in Magick_png_read_raw_profile\\nState: closed\\nCreated by: henices\\nCreated at: 2017-11-21 05:39:48+00:00\\nLabels: bug\\n\\nIssue Body:\\n$ convert -version\\nVersion: ImageMagick 7.0.7-12 Q16 x86_64 2017-11-21 http://www.imagemagick.org\\nCopyright: \\u00a9 1999-2017 ImageMagick Studio LLC\\nLicense: http://www.imagemagick.org/script/license.php\\nFeatures: Cipher DPC HDRI OpenMP \\nDelegates (built-in): bzlib fontconfig freetype jng jpeg pangocairo png x xml zlib\\n\\ncommit: 6645a122ee83105008e8447f92555e4a9e307ecf  compile at ubuntu 14.04 x86_64\\n\\nTrigger Command:  **convert Magick_png_read_raw_profile-heap-overflow /dev/null**\\n\\n```\\n==25042== ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60060001dd58 at pc 0x7f27e3c6f8a7 bp 0x7fff78c5f4c0 sp 0x7fff78c5f4b8\\nREAD of size 1 at 0x60060001dd58 thread T0\\n    #0 0x7f27e3c6f8a6 in Magick_png_read_raw_profile /home/henices/ImageMagick/coders/png.c:1804\\n    #1 0x7f27e3c7982f in ReadOnePNGImage /home/henices/ImageMagick/coders/png.c:3855\\n    #2 0x7f27e3c7ac76 in ReadPNGImage /home/henices/ImageMagick/coders/png.c:4236\\n    #3 0x7f27e361f721 in ReadImage /home/henices/ImageMagick/MagickCore/constitute.c:497\\n    #4 0x7f27e3621d87 in ReadImages /home/henices/ImageMagick/MagickCore/constitute.c:866\\n    #5 0x7f27e2e3b79b in ConvertImageCommand /home/henices/ImageMagick/MagickWand/convert.c:641\\n    #6 0x7f27e2fdea10 in MagickCommandGenesis /home/henices/ImageMagick/MagickWand/mogrify.c:183\\n    #7 0x40164c in MagickMain /home/henices/ImageMagick/utilities/magick.c:149\\n    #8 0x4017e1 in main /home/henices/ImageMagick/utilities/magick.c:180\\n    #9 0x7f27e2761f44 in __libc_start_main /build/eglibc-SvCtMH/eglibc-2.19/csu/libc-start.c:287\\n    #10 0x401198 in _start (/usr/local/bin/magick+0x401198)\\n0x60060001dd58 is located 0 bytes to the right of 24-byte region [0x60060001dd40,0x60060001dd58)\\nallocated by thread T0 here:\\n    #0 0x7f27e42ba41a in malloc (/usr/lib/x86_64-linux-gnu/libasan.so.0+0x1541a)\\n    #1 0x7f27e3800279 in AcquireMagickMemory /home/henices/ImageMagick/MagickCore/memory.c:464\\n    #2 0x7f27e3c6f389 in Magick_png_malloc /home/henices/ImageMagick/coders/png.c:1756\\n    #3 0x7f27e1ec5fff in png_malloc (/lib/x86_64-linux-gnu/libpng12.so.0+0x1afff)\\nSUMMARY: AddressSanitizer: heap-buffer-overflow /home/henices/ImageMagick/coders/png.c:1804 Magick_png_read_raw_profile\\nShadow bytes around the buggy address:\\n  0x0c013fffbb50: 00 00 fa fa 00 00 00 00 fa fa 00 00 00 00 fa fa\\n  0x0c013fffbb60: 00 00 00 02 fa fa 00 00 03 fa fa fa 00 00 00 00\\n  0x0c013fffbb70: fa fa 00 00 04 fa fa fa 00 00 00 00 fa fa 00 00\\n  0x0c013fffbb80: 03 fa fa fa 00 00 00 00 fa fa 00 00 06 fa fa fa\\n  0x0c013fffbb90: 00 00 00 00 fa fa 00 00 00 fa fa fa 00 00 00 00\\n=>0x0c013fffbba0: fa fa 00 00 00 01 fa fa 00 00 00[fa]fa fa fd fd\\n  0x0c013fffbbb0: fd fd fa fa fd fd fd fa fa fa 00 00 00 00 fa fa\\n  0x0c013fffbbc0: 00 00 06 fa fa fa 00 00 00 00 fa fa 00 00 06 fa\\n  0x0c013fffbbd0: fa fa 00 00 00 00 fa fa 00 00 05 fa fa fa 00 00\\n  0x0c013fffbbe0: 00 00 fa fa 00 00 04 fa fa fa 00 00 00 00 fa fa\\n  0x0c013fffbbf0: 00 00 00 07 fa fa 00 00 00 03 fa fa 00 00 00 00\\nShadow byte legend (one shadow byte represents 8 application bytes):\\n  Addressable:           00\\n  Partially addressable: 01 02 03 04 05 06 07 \\n  Heap left redzone:     fa\\n  Heap righ redzone:     fb\\n  Freed Heap region:     fd\\n  Stack left redzone:    f1\\n  Stack mid redzone:     f2\\n  Stack right redzone:   f3\\n  Stack partial redzone: f4\\n  Stack after return:    f5\\n  Stack use after scope: f8\\n  Global redzone:        f9\\n  Global init order:     f6\\n  Poisoned by user:      f7\\n  ASan internal:         fe\\n==25042== ABORTING\\n```\\n\\ntestcase:\\nhttps://github.com/henices/pocs/raw/master/Magick_png_read_raw_profile-heap-overflow\\n\\nCredit: NSFocus Security Team <security (at) nsfocus (dot) com>\\n\\n\\nComments:\\nComment by urban-warrior on 2017-11-21 12:45:50+00:00:\\nUnfortunately we cannot reproduce the problem.  With the latest ImageMagick release from the master branch, we get:\\n\\n```\\n$ convert Magick_png_read_raw_profile-heap-overflow /dev/null\\nconvert: gAMA: gamma value out of range `Magick_png_read_raw_profile-heap-overflow' @ warning/png.c/MagickPNGWarningHandler/1744.\\nconvert: zTXt: invalid distance too far back `Magick_png_read_raw_profile-heap-overflow' @ warning/png.c/MagickPNGWarningHandler/1744.\\n```\\n\\n\\n---\\n\\nComment by henices on 2017-11-21 13:58:54+00:00:\\nI got the same output on fedora 26, but on ubuntu it makes crash.  on ubuntu 14.04  convert command use libpng12,  on fedora convert command use libpng16,   what's your linux distribution?\\n\\n---\\n\\nComment by henices on 2017-11-22 04:23:44+00:00:\\nI find the root cause,  when i use the libpng16 in ubuntu this crash is gone away. \\nuse libpng12 in ubuntu,  we will get a asan heap-buffer-overflow output.\\n\\n---\\n\\nComment by urban-warrior on 2017-11-22 15:05:23+00:00:\\nThanks for the problem report.  We can reproduce it and will have a patch to fix it in GIT master branch @ https://github.com/ImageMagick/ImageMagick later today.  The patch will be available in the beta releases of ImageMagick @ https://www.imagemagick.org/download/beta/ by sometime tomorrow. \\n\\n\\n---\\n\\nComment by nohmask on 2017-12-11 04:08:55+00:00:\\nThis was assigned CVE-2017-17504.\\n\\nCommit References:\\n6645a122ee83105008e8447f92555e4a9e307ecf\",\n  \"candidate_fixes\": [\n    {\n      \"sha\": \"6645a122ee83105008e8447f92555e4a9e307ecf\",\n      \"url\": \"https://github.com/imagemagick/imagemagick/commit/6645a122ee83105008e8447f92555e4a9e307ecf\"\n    },\n    {\n      \"sha\": \"59c49559e302e06bfba46cb6feb4e39adbe675b6\",\n      \"url\": \"https://github.com/ImageMagick/ImageMagick/commit/59c49559e302e06bfba46cb6feb4e39adbe675b6\"\n    },\n    {\n      \"sha\": \"fb89192c4ca1600741af79dd22166a7d91e76924\",\n      \"url\": \"https://github.com/ImageMagick/ImageMagick/commit/fb89192c4ca1600741af79dd22166a7d91e76924\"\n    },\n    {\n      \"sha\": \"ce3a586a43a7d13442587eb7f28d129557b6a135\",\n      \"url\": \"https://github.com/ImageMagick/ImageMagick/commit/ce3a586a43a7d13442587eb7f28d129557b6a135\"\n    }\n  ]\n}\n```\nI will delegate to specialized agents sequentially: BuilderAgent, ExploiterAgent, FixerAgent.\nPlease start by delegating to the BuilderAgent.\n",
  "instance": {
    "instance_id": "imagemagick.cve-2017-17504",
    "repo": "imagemagick/imagemagick",
    "base_commit": "4b484c9ca35c78a828c3ca6a8d077ac1ce3fdecb",
    "work_dir": "/src/imagemagick",
    "build_sh": "#!/bin/bash -eu\n# Minimized build script with only core build commands\nset -eu\n./configure --prefix=\"$WORK\" --disable-shared --disable-docs\nmake \"-j$(nproc)\"\nmake install -j$(nproc)",
    "bug_description": "================= Bug Report (1/1) ==================\n## Source: GitHub Issue\n## URL: https://github.com/ImageMagick/ImageMagick/issues/872\n## Description:\nIssue: ImageMagick/ImageMagick#872\nTitle: heap-buffer-overflow in Magick_png_read_raw_profile\nState: closed\nCreated by: henices\nCreated at: 2017-11-21 05:39:48+00:00\nLabels: bug\n\nIssue Body:\n$ convert -version\nVersion: ImageMagick 7.0.7-12 Q16 x86_64 2017-11-21 http://www.imagemagick.org\nCopyright: \u00a9 1999-2017 ImageMagick Studio LLC\nLicense: http://www.imagemagick.org/script/license.php\nFeatures: Cipher DPC HDRI OpenMP \nDelegates (built-in): bzlib fontconfig freetype jng jpeg pangocairo png x xml zlib\n\ncommit: 6645a122ee83105008e8447f92555e4a9e307ecf  compile at ubuntu 14.04 x86_64\n\nTrigger Command:  **convert Magick_png_read_raw_profile-heap-overflow /dev/null**\n\n```\n==25042== ERROR: AddressSanitizer: heap-buffer-overflow on address 0x60060001dd58 at pc 0x7f27e3c6f8a7 bp 0x7fff78c5f4c0 sp 0x7fff78c5f4b8\nREAD of size 1 at 0x60060001dd58 thread T0\n    #0 0x7f27e3c6f8a6 in Magick_png_read_raw_profile /home/henices/ImageMagick/coders/png.c:1804\n    #1 0x7f27e3c7982f in ReadOnePNGImage /home/henices/ImageMagick/coders/png.c:3855\n    #2 0x7f27e3c7ac76 in ReadPNGImage /home/henices/ImageMagick/coders/png.c:4236\n    #3 0x7f27e361f721 in ReadImage /home/henices/ImageMagick/MagickCore/constitute.c:497\n    #4 0x7f27e3621d87 in ReadImages /home/henices/ImageMagick/MagickCore/constitute.c:866\n    #5 0x7f27e2e3b79b in ConvertImageCommand /home/henices/ImageMagick/MagickWand/convert.c:641\n    #6 0x7f27e2fdea10 in MagickCommandGenesis /home/henices/ImageMagick/MagickWand/mogrify.c:183\n    #7 0x40164c in MagickMain /home/henices/ImageMagick/utilities/magick.c:149\n    #8 0x4017e1 in main /home/henices/ImageMagick/utilities/magick.c:180\n    #9 0x7f27e2761f44 in __libc_start_main /build/eglibc-SvCtMH/eglibc-2.19/csu/libc-start.c:287\n    #10 0x401198 in _start (/usr/local/bin/magick+0x401198)\n0x60060001dd58 is located 0 bytes to the right of 24-byte region [0x60060001dd40,0x60060001dd58)\nallocated by thread T0 here:\n    #0 0x7f27e42ba41a in malloc (/usr/lib/x86_64-linux-gnu/libasan.so.0+0x1541a)\n    #1 0x7f27e3800279 in AcquireMagickMemory /home/henices/ImageMagick/MagickCore/memory.c:464\n    #2 0x7f27e3c6f389 in Magick_png_malloc /home/henices/ImageMagick/coders/png.c:1756\n    #3 0x7f27e1ec5fff in png_malloc (/lib/x86_64-linux-gnu/libpng12.so.0+0x1afff)\nSUMMARY: AddressSanitizer: heap-buffer-overflow /home/henices/ImageMagick/coders/png.c:1804 Magick_png_read_raw_profile\nShadow bytes around the buggy address:\n  0x0c013fffbb50: 00 00 fa fa 00 00 00 00 fa fa 00 00 00 00 fa fa\n  0x0c013fffbb60: 00 00 00 02 fa fa 00 00 03 fa fa fa 00 00 00 00\n  0x0c013fffbb70: fa fa 00 00 04 fa fa fa 00 00 00 00 fa fa 00 00\n  0x0c013fffbb80: 03 fa fa fa 00 00 00 00 fa fa 00 00 06 fa fa fa\n  0x0c013fffbb90: 00 00 00 00 fa fa 00 00 00 fa fa fa 00 00 00 00\n=>0x0c013fffbba0: fa fa 00 00 00 01 fa fa 00 00 00[fa]fa fa fd fd\n  0x0c013fffbbb0: fd fd fa fa fd fd fd fa fa fa 00 00 00 00 fa fa\n  0x0c013fffbbc0: 00 00 06 fa fa fa 00 00 00 00 fa fa 00 00 06 fa\n  0x0c013fffbbd0: fa fa 00 00 00 00 fa fa 00 00 05 fa fa fa 00 00\n  0x0c013fffbbe0: 00 00 fa fa 00 00 04 fa fa fa 00 00 00 00 fa fa\n  0x0c013fffbbf0: 00 00 00 07 fa fa 00 00 00 03 fa fa 00 00 00 00\nShadow byte legend (one shadow byte represents 8 application bytes):\n  Addressable:           00\n  Partially addressable: 01 02 03 04 05 06 07 \n  Heap left redzone:     fa\n  Heap righ redzone:     fb\n  Freed Heap region:     fd\n  Stack left redzone:    f1\n  Stack mid redzone:     f2\n  Stack right redzone:   f3\n  Stack partial redzone: f4\n  Stack after return:    f5\n  Stack use after scope: f8\n  Global redzone:        f9\n  Global init order:     f6\n  Poisoned by user:      f7\n  ASan internal:         fe\n==25042== ABORTING\n```\n\ntestcase:\nhttps://github.com/henices/pocs/raw/master/Magick_png_read_raw_profile-heap-overflow\n\nCredit: NSFocus Security Team <security (at) nsfocus (dot) com>\n\n\nComments:\nComment by urban-warrior on 2017-11-21 12:45:50+00:00:\nUnfortunately we cannot reproduce the problem.  With the latest ImageMagick release from the master branch, we get:\n\n```\n$ convert Magick_png_read_raw_profile-heap-overflow /dev/null\nconvert: gAMA: gamma value out of range `Magick_png_read_raw_profile-heap-overflow' @ warning/png.c/MagickPNGWarningHandler/1744.\nconvert: zTXt: invalid distance too far back `Magick_png_read_raw_profile-heap-overflow' @ warning/png.c/MagickPNGWarningHandler/1744.\n```\n\n\n---\n\nComment by henices on 2017-11-21 13:58:54+00:00:\nI got the same output on fedora 26, but on ubuntu it makes crash.  on ubuntu 14.04  convert command use libpng12,  on fedora convert command use libpng16,   what's your linux distribution?\n\n---\n\nComment by henices on 2017-11-22 04:23:44+00:00:\nI find the root cause,  when i use the libpng16 in ubuntu this crash is gone away. \nuse libpng12 in ubuntu,  we will get a asan heap-buffer-overflow output.\n\n---\n\nComment by urban-warrior on 2017-11-22 15:05:23+00:00:\nThanks for the problem report.  We can reproduce it and will have a patch to fix it in GIT master branch @ https://github.com/ImageMagick/ImageMagick later today.  The patch will be available in the beta releases of ImageMagick @ https://www.imagemagick.org/download/beta/ by sometime tomorrow. \n\n\n---\n\nComment by nohmask on 2017-12-11 04:08:55+00:00:\nThis was assigned CVE-2017-17504.\n\nCommit References:\n6645a122ee83105008e8447f92555e4a9e307ecf",
    "candidate_fixes": [
      {
        "sha": "6645a122ee83105008e8447f92555e4a9e307ecf",
        "url": "https://github.com/imagemagick/imagemagick/commit/6645a122ee83105008e8447f92555e4a9e307ecf"
      },
      {
        "sha": "59c49559e302e06bfba46cb6feb4e39adbe675b6",
        "url": "https://github.com/ImageMagick/ImageMagick/commit/59c49559e302e06bfba46cb6feb4e39adbe675b6"
      },
      {
        "sha": "fb89192c4ca1600741af79dd22166a7d91e76924",
        "url": "https://github.com/ImageMagick/ImageMagick/commit/fb89192c4ca1600741af79dd22166a7d91e76924"
      },
      {
        "sha": "ce3a586a43a7d13442587eb7f28d129557b6a135",
        "url": "https://github.com/ImageMagick/ImageMagick/commit/ce3a586a43a7d13442587eb7f28d129557b6a135"
      }
    ]
  },
  "result": {
    "execution": {
      "builder": {
        "success": true,
        "command": "cd /src/imagemagick && git reset --hard 4b484c9ca35c78a828c3ca6a8d077ac1ce3fdecb && secb build",
        "exit_code": 0,
        "message": "Build successful at base commit."
      },
      "exploiter": {
        "success": false,
        "command": "secb repro",
        "exit_code": 0,
        "message": "Reproduction failed at base commit (exit code 0):\nREPRODUCING THE ISSUE FOR imagemagick.cve-2017-17504...\nTriggering heap-buffer-overflow in Magick_png_read_raw_profile...\nconvert: gAMA: gamma value out of range `/testcase/Magick_png_read_raw_profile-heap-overflow' @ warning/png.c/MagickPNGWarningHandler/1744.\nconvert: zTXt: invalid distance too far back `/testcase/Magick_png_read_raw_profile-heap-overflow' @ warning/png.c/MagickPNGWarningHandler/1744."
      },
      "fixer": {
        "success": false,
        "command": "",
        "exit_code": -1,
        "message": "Verification not run"
      }
    },
    "build_sh": "#!/bin/bash\n\n# Build script for ImageMagick\n\n# Ensure the script is executed from the correct directory\nif [ ! -f configure ]; then\n  echo \"Error: configure script not found. Please run this script from the ImageMagick source directory.\"\n  exit 1\nfi\n\n# Set default installation directory if not set\nWORK=${WORK:-/usr/local}\n\n# Clean previous builds\nmake clean\n\n# Configure the build\nexport CFLAGS=\"$CFLAGS -fsanitize=address\"\nexport CXXFLAGS=\"$CXXFLAGS -fsanitize=address\"\n./configure --prefix=\"$WORK\" --disable-shared --disable-docs\n\n# Build the project using all available processors\nmake -j$(nproc)",
    "secb_sh": "#!/bin/bash\nset -euo pipefail\n\nbuild() {\n    echo \"BUILDING THE PROJECT...\"\n\n    # Handle git sub-modules\n    if [[ -f .gitmodules || -f .gitmodule ]]; then\n        echo \"Detected git sub-modules - initialising/updating...\"\n        git submodule update --init --recursive\n    else\n        echo \"No git sub-modules found - skipping update.\"\n    fi\n\n    # Check for repo_changes.diff and apply if it exists and hasn't been applied yet\n    if [[ -f /testcase/repo_changes.diff ]]; then\n        # Check if the patch has already been applied to avoid re-applying\n        if ! git apply --check /testcase/repo_changes.diff &>/dev/null; then\n            echo \"Repository changes already applied or cannot be applied cleanly. Proceeding with build.\"\n        else\n            echo \"Applying repository changes from repo_changes.diff...\"\n            git apply /testcase/repo_changes.diff || echo \"Warning: Could not apply repo_changes.diff cleanly. Proceeding anyway.\"\n        fi\n    fi\n\n    # stdout: /dev/null\n    # stderr: grep filters out \"warning:\" and lets everything else through\n    if /usr/local/bin/compile \\\n         1>/dev/null \\\n         2> >(grep -Fv --line-buffered -e \"warning:\" -e \"SyntaxWarning:\" -e \"WARNING:\" >&2); then\n        echo \"BUILD COMPLETED SUCCESSFULLY!\"\n    else\n        echo \"BUILD FAILED!\"\n        exit 1\n    fi\n}\n\nrepro() {\n    echo \"REPRODUCING THE ISSUE FOR imagemagick.cve-2017-17504...\"\n    # TODO: Add commands to trigger the specific vulnerability\n    # For now, it's a placeholder.\n    echo \"Triggering heap-buffer-overflow in Magick_png_read_raw_profile...\"\n    /src/imagemagick/utilities/magick convert /testcase/Magick_png_read_raw_profile-heap-overflow /dev/null\n    # NOTE: YOU SHOULD NOT RETURN/EXIT 0 IN THIS FUNCTION.\n    # Example: /out/fuzzer /testcase/poc_file\n}\n\npatch() {\n    echo \"PATCHING THE PROJECT...\"\n    cd /src/imagemagick\n\n    # Check for repo_changes.diff and apply if it exists and hasn't been applied yet\n    if [[ -f /testcase/repo_changes.diff ]]; then\n        # Check if the patch has already been applied to avoid re-applying\n        if ! git apply --check /testcase/repo_changes.diff &>/dev/null; then\n            echo \"Repository changes already applied or cannot be applied cleanly. Proceeding with patch.\"\n        else\n            echo \"Applying repository changes from repo_changes.diff...\"\n            git apply /testcase/repo_changes.diff || echo \"Warning: Could not apply repo_changes.diff cleanly. Proceeding anyway.\"\n        fi\n    fi\n\n    if git apply /testcase/model_patch.diff; then\n        echo \"PATCH APPLIED SUCCESSFULLY!\"\n    else\n        echo \"PATCH APPLICATION FAILED!\"\n        exit 1\n    fi\n}\n\nif [ \"$#\" -ge 1 ]; then\n    command=\"$1\"\n\n    case \"$command\" in\n        build)\n            build \"$@\"\n            ;;\n        repro)\n            repro \"$@\"\n            ;;\n        patch)\n            patch \"$@\"\n            ;;\n        *)\n            echo \"Unknown command: $command\"\n            echo \"Usage: secb [build|repro|patch]\"\n            exit 1\n            ;;\n    esac\nelse\n    echo \"Usage: secb [build|repro|patch]\"\n    exit 1\nfi",
    "artifacts": {
      "repo_changes.diff": "ZGlmZiAtLWdpdCBhL01hZ2lja0NvcmUvYmxvYi5jIGIvTWFnaWNrQ29yZS9ibG9iLmMKaW5kZXggYjI0ODFlOTU1Li5hMTI0YmFhNjIgMTAwNjQ0Ci0tLSBhL01hZ2lja0NvcmUvYmxvYi5jCisrKyBiL01hZ2lja0NvcmUvYmxvYi5jCkBAIC00NTQsMTUgKzQ1NCwxMSBAQCBNYWdpY2tFeHBvcnQgSW1hZ2UgKkJsb2JUb0ltYWdlKGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbyxjb25zdCB2b2lkICpibG9iLAogICAgIH0KICAgaWYgKEdldE1hZ2lja0Jsb2JTdXBwb3J0KG1hZ2lja19pbmZvKSAhPSBNYWdpY2tGYWxzZSkKICAgICB7Ci0gICAgICBjaGFyCi0gICAgICAgIGZpbGVuYW1lW01hZ2lja1BhdGhFeHRlbnRdOwotCiAgICAgICAvKgogICAgICAgICBOYXRpdmUgYmxvYiBzdXBwb3J0IGZvciB0aGlzIGltYWdlIGZvcm1hdC4KICAgICAgICovCi0gICAgICAodm9pZCkgQ29weU1hZ2lja1N0cmluZyhmaWxlbmFtZSxibG9iX2luZm8tPmZpbGVuYW1lLE1hZ2lja1BhdGhFeHRlbnQpOwogICAgICAgKHZvaWQpIEZvcm1hdExvY2FsZVN0cmluZyhibG9iX2luZm8tPmZpbGVuYW1lLE1hZ2lja1BhdGhFeHRlbnQsIiVzOiVzIiwKLSAgICAgICAgYmxvYl9pbmZvLT5tYWdpY2ssZmlsZW5hbWUpOworICAgICAgICBibG9iX2luZm8tPm1hZ2ljayxpbWFnZV9pbmZvLT5maWxlbmFtZSk7CiAgICAgICBpbWFnZT1SZWFkSW1hZ2UoYmxvYl9pbmZvLGV4Y2VwdGlvbik7CiAgICAgICBpZiAoaW1hZ2UgIT0gKEltYWdlICopIE5VTEwpCiAgICAgICAgICh2b2lkKSBEZXRhY2hCbG9iKGltYWdlLT5ibG9iKTsKQEAgLTc2OCwxNiArNzY0LDEyIEBAIE1hZ2lja0V4cG9ydCBJbWFnZSAqQ3VzdG9tU3RyZWFtVG9JbWFnZShjb25zdCBJbWFnZUluZm8gKmltYWdlX2luZm8sCiAgIGlmICgoR2V0TWFnaWNrQmxvYlN1cHBvcnQobWFnaWNrX2luZm8pICE9IE1hZ2lja0ZhbHNlKSB8fAogICAgICAgKGJsb2JfaW5mby0+Y3VzdG9tX3N0cmVhbSA9PSAoQ3VzdG9tU3RyZWFtSW5mbyAqKSBOVUxMKSkKICAgICB7Ci0gICAgICBjaGFyCi0gICAgICAgIGZpbGVuYW1lW01hZ2lja1BhdGhFeHRlbnRdOwotCiAgICAgICAvKgogICAgICAgICBOYXRpdmUgYmxvYiBzdXBwb3J0IGZvciB0aGlzIGltYWdlIGZvcm1hdCBvciBTZXRJbWFnZUluZm8gY2hhbmdlZCB0aGUKICAgICAgICAgYmxvYiB0byBhIGZpbGUuCiAgICAgICAqLwotICAgICAgKHZvaWQpIENvcHlNYWdpY2tTdHJpbmcoZmlsZW5hbWUsYmxvYl9pbmZvLT5maWxlbmFtZSxNYWdpY2tQYXRoRXh0ZW50KTsKICAgICAgICh2b2lkKSBGb3JtYXRMb2NhbGVTdHJpbmcoYmxvYl9pbmZvLT5maWxlbmFtZSxNYWdpY2tQYXRoRXh0ZW50LCIlczolcyIsCi0gICAgICAgIGJsb2JfaW5mby0+bWFnaWNrLGZpbGVuYW1lKTsKKyAgICAgICAgYmxvYl9pbmZvLT5tYWdpY2ssaW1hZ2VfaW5mby0+ZmlsZW5hbWUpOwogICAgICAgaW1hZ2U9UmVhZEltYWdlKGJsb2JfaW5mbyxleGNlcHRpb24pOwogICAgICAgaWYgKGltYWdlICE9IChJbWFnZSAqKSBOVUxMKQogICAgICAgICAodm9pZCkgQ2xvc2VCbG9iKGltYWdlKTsKQEAgLTQ2NzcsNiArNDY2OSwyOCBAQCBNYWdpY2tFeHBvcnQgTWFnaWNrT2Zmc2V0VHlwZSBTZWVrQmxvYihJbWFnZSAqaW1hZ2UsCiAgICAgICAgICAgYnJlYWs7CiAgICAgICAgIH0KICAgICAgIH0KKyAgICAgIGlmIChibG9iX2luZm8tPm9mZnNldCA8IChNYWdpY2tPZmZzZXRUeXBlKSAoKG9mZl90KSBibG9iX2luZm8tPmxlbmd0aCkpCisgICAgICAgIHsKKyAgICAgICAgICBibG9iX2luZm8tPmVvZj1NYWdpY2tGYWxzZTsKKyAgICAgICAgICBicmVhazsKKyAgICAgICAgfQorICAgICAgaWYgKGJsb2JfaW5mby0+b2Zmc2V0IDwgKE1hZ2lja09mZnNldFR5cGUpICgob2ZmX3QpIGJsb2JfaW5mby0+ZXh0ZW50KSkKKyAgICAgICAgYnJlYWs7CisgICAgICBpZiAoYmxvYl9pbmZvLT5tYXBwZWQgIT0gTWFnaWNrRmFsc2UpCisgICAgICAgIHsKKyAgICAgICAgICBibG9iX2luZm8tPmVvZj1NYWdpY2tUcnVlOworICAgICAgICAgIHJldHVybigtMSk7CisgICAgICAgIH0KKyAgICAgIGJsb2JfaW5mby0+ZXh0ZW50PShzaXplX3QpIChibG9iX2luZm8tPm9mZnNldCtibG9iX2luZm8tPnF1YW50dW0pOworICAgICAgYmxvYl9pbmZvLT5xdWFudHVtPDw9MTsKKyAgICAgIGJsb2JfaW5mby0+ZGF0YT0odW5zaWduZWQgY2hhciAqKSBSZXNpemVRdWFudHVtTWVtb3J5KGJsb2JfaW5mby0+ZGF0YSwKKyAgICAgICAgYmxvYl9pbmZvLT5leHRlbnQrMSxzaXplb2YoKmJsb2JfaW5mby0+ZGF0YSkpOworICAgICAgKHZvaWQpIFN5bmNCbG9iKGltYWdlKTsKKyAgICAgIGlmIChibG9iX2luZm8tPmRhdGEgPT0gTlVMTCkKKyAgICAgICAgeworICAgICAgICAgICh2b2lkKSBEZXRhY2hCbG9iKGJsb2JfaW5mbyk7CisgICAgICAgICAgcmV0dXJuKC0xKTsKKyAgICAgICAgfQogICAgICAgYnJlYWs7CiAgICAgfQogICAgIGNhc2UgQ3VzdG9tU3RyZWFtOgpkaWZmIC0tZ2l0IGEvTWFnaWNrQ29yZS9jYWNoZS5jIGIvTWFnaWNrQ29yZS9jYWNoZS5jCmluZGV4IDQzODUwN2UyZS4uZGFlM2FhOGQ3IDEwMDY0NAotLS0gYS9NYWdpY2tDb3JlL2NhY2hlLmMKKysrIGIvTWFnaWNrQ29yZS9jYWNoZS5jCkBAIC01MzYsNyArNTM2LDcgQEAgc3RhdGljIE1hZ2lja0Jvb2xlYW5UeXBlIENsb25lUGl4ZWxDYWNoZVJlcG9zaXRvcnkoCiAgIENhY2hlSW5mbyAqbWFnaWNrX3Jlc3RyaWN0IGNsb25lX2luZm8sQ2FjaGVJbmZvICptYWdpY2tfcmVzdHJpY3QgY2FjaGVfaW5mbywKICAgRXhjZXB0aW9uSW5mbyAqZXhjZXB0aW9uKQogewotI2RlZmluZSBNYXhDYWNoZVRocmVhZHMgICgoc2l6ZV90KSBHZXRNYWdpY2tSZXNvdXJjZUxpbWl0KFRocmVhZFJlc291cmNlKSkKKyNkZWZpbmUgTWF4Q2FjaGVUaHJlYWRzICBHZXRNYWdpY2tSZXNvdXJjZUxpbWl0KFRocmVhZFJlc291cmNlKQogI2RlZmluZSBjYWNoZV9udW1iZXJfdGhyZWFkcyhzb3VyY2UsZGVzdGluYXRpb24sY2h1bmssbXVsdGl0aHJlYWRlZCkgXAogICBudW1fdGhyZWFkcygobXVsdGl0aHJlYWRlZCkgPT0gMCA/IDEgOiBcCiAgICAgKCgoc291cmNlKS0+dHlwZSAhPSBNZW1vcnlDYWNoZSkgJiYgXApAQCAtMzQzMiw3ICszNDMyLDYgQEAgc3RhdGljIE1hZ2lja0Jvb2xlYW5UeXBlIE9wZW5QaXhlbENhY2hlKEltYWdlICppbWFnZSxjb25zdCBNYXBNb2RlIG1vZGUsCiAgICAgbWVzc2FnZVtNYWdpY2tQYXRoRXh0ZW50XTsKIAogICBjb25zdCBjaGFyCi0gICAgKmhvc3RzLAogICAgICp0eXBlOwogCiAgIE1hZ2lja0Jvb2xlYW5UeXBlCkBAIC0zNTIzLDEyICszNTIyLDExIEBAIHN0YXRpYyBNYWdpY2tCb29sZWFuVHlwZSBPcGVuUGl4ZWxDYWNoZShJbWFnZSAqaW1hZ2UsY29uc3QgTWFwTW9kZSBtb2RlLAogICAgIHN0YXR1cz1NYWdpY2tGYWxzZTsKICAgbGVuZ3RoPW51bWJlcl9waXhlbHMqKGNhY2hlX2luZm8tPm51bWJlcl9jaGFubmVscypzaXplb2YoUXVhbnR1bSkrCiAgICAgY2FjaGVfaW5mby0+bWV0YWNvbnRlbnRfZXh0ZW50KTsKLSAgaWYgKChzdGF0dXMgIT0gTWFnaWNrRmFsc2UpICYmCi0gICAgICAobGVuZ3RoID09IChNYWdpY2tTaXplVHlwZSkgKChzaXplX3QpIGxlbmd0aCkpICYmCi0gICAgICAoKGNhY2hlX2luZm8tPnR5cGUgPT0gVW5kZWZpbmVkQ2FjaGUpIHx8IChjYWNoZV9pbmZvLT50eXBlID09IE1lbW9yeUNhY2hlKSkpCisgIGlmICgoc3RhdHVzICE9IE1hZ2lja0ZhbHNlKSAmJiAobGVuZ3RoID09IChNYWdpY2tTaXplVHlwZSkgKChzaXplX3QpIGxlbmd0aCkpKQogICAgIHsKICAgICAgIHN0YXR1cz1BY3F1aXJlTWFnaWNrUmVzb3VyY2UoTWVtb3J5UmVzb3VyY2UsY2FjaGVfaW5mby0+bGVuZ3RoKTsKLSAgICAgIGlmIChzdGF0dXMgIT0gTWFnaWNrRmFsc2UpCisgICAgICBpZiAoKChjYWNoZV9pbmZvLT50eXBlID09IFVuZGVmaW5lZENhY2hlKSAmJiAoc3RhdHVzICE9IE1hZ2lja0ZhbHNlKSkgfHwKKyAgICAgICAgICAoY2FjaGVfaW5mby0+dHlwZSA9PSBNZW1vcnlDYWNoZSkpCiAgICAgICAgIHsKICAgICAgICAgICBzdGF0dXM9TWFnaWNrVHJ1ZTsKICAgICAgICAgICBpZiAoY2FjaGVfYW5vbnltb3VzX21lbW9yeSA8PSAwKQpAQCAtMzU4MCwxOCArMzU3OCwxOSBAQCBzdGF0aWMgTWFnaWNrQm9vbGVhblR5cGUgT3BlblBpeGVsQ2FjaGUoSW1hZ2UgKmltYWdlLGNvbnN0IE1hcE1vZGUgbW9kZSwKICAgICAgICAgICAgICAgcmV0dXJuKHN0YXR1cyA9PSAwID8gTWFnaWNrRmFsc2UgOiBNYWdpY2tUcnVlKTsKICAgICAgICAgICAgIH0KICAgICAgICAgfQorICAgICAgUmVsaW5xdWlzaE1hZ2lja1Jlc291cmNlKE1lbW9yeVJlc291cmNlLGNhY2hlX2luZm8tPmxlbmd0aCk7CiAgICAgfQorICAvKgorICAgIENyZWF0ZSBwaXhlbCBjYWNoZSBvbiBkaXNrLgorICAqLwogICBzdGF0dXM9QWNxdWlyZU1hZ2lja1Jlc291cmNlKERpc2tSZXNvdXJjZSxjYWNoZV9pbmZvLT5sZW5ndGgpOwotICBob3N0cz0oY29uc3QgY2hhciAqKSBHZXRJbWFnZVJlZ2lzdHJ5KFN0cmluZ1JlZ2lzdHJ5VHlwZSwiY2FjaGU6aG9zdHMiLAotICAgIGV4Y2VwdGlvbik7Ci0gIGlmICgoc3RhdHVzID09IE1hZ2lja0ZhbHNlKSAmJiAoaG9zdHMgIT0gKGNvbnN0IGNoYXIgKikgTlVMTCkpCisgIGlmICgoc3RhdHVzID09IE1hZ2lja0ZhbHNlKSB8fCAoY2FjaGVfaW5mby0+dHlwZSA9PSBEaXN0cmlidXRlZENhY2hlKSkKICAgICB7CiAgICAgICBEaXN0cmlidXRlQ2FjaGVJbmZvCiAgICAgICAgICpzZXJ2ZXJfaW5mbzsKIAotICAgICAgLyoKLSAgICAgICAgRGlzdHJpYnV0ZSB0aGUgcGl4ZWwgY2FjaGUgdG8gYSByZW1vdGUgc2VydmVyLgotICAgICAgKi8KKyAgICAgIGlmIChjYWNoZV9pbmZvLT50eXBlID09IERpc3RyaWJ1dGVkQ2FjaGUpCisgICAgICAgIFJlbGlucXVpc2hNYWdpY2tSZXNvdXJjZShEaXNrUmVzb3VyY2UsY2FjaGVfaW5mby0+bGVuZ3RoKTsKICAgICAgIHNlcnZlcl9pbmZvPUFjcXVpcmVEaXN0cmlidXRlQ2FjaGVJbmZvKGV4Y2VwdGlvbik7CiAgICAgICBpZiAoc2VydmVyX2luZm8gIT0gKERpc3RyaWJ1dGVDYWNoZUluZm8gKikgTlVMTCkKICAgICAgICAgewpAQCAtMzY0MSwxNyArMzY0MCw3IEBAIHN0YXRpYyBNYWdpY2tCb29sZWFuVHlwZSBPcGVuUGl4ZWxDYWNoZShJbWFnZSAqaW1hZ2UsY29uc3QgTWFwTW9kZSBtb2RlLAogICAgICAgICAgICAgICByZXR1cm4oc3RhdHVzID09IDAgPyBNYWdpY2tGYWxzZSA6IE1hZ2lja1RydWUpOwogICAgICAgICAgICAgfQogICAgICAgICB9Ci0gICAgICBjYWNoZV9pbmZvLT50eXBlPVVuZGVmaW5lZENhY2hlOwotICAgICAgKHZvaWQpIFRocm93TWFnaWNrRXhjZXB0aW9uKGV4Y2VwdGlvbixHZXRNYWdpY2tNb2R1bGUoKSxDYWNoZUVycm9yLAotICAgICAgICAiQ2FjaGVSZXNvdXJjZXNFeGhhdXN0ZWQiLCJgJXMnIixpbWFnZS0+ZmlsZW5hbWUpOwotICAgICAgcmV0dXJuKE1hZ2lja0ZhbHNlKTsKLSAgICB9Ci0gIC8qCi0gICAgQ3JlYXRlIHBpeGVsIGNhY2hlIG9uIGRpc2suCi0gICovCi0gIGlmIChzdGF0dXMgPT0gTWFnaWNrRmFsc2UpCi0gICAgewotICAgICAgY2FjaGVfaW5mby0+dHlwZT1VbmRlZmluZWRDYWNoZTsKKyAgICAgIFJlbGlucXVpc2hNYWdpY2tSZXNvdXJjZShEaXNrUmVzb3VyY2UsY2FjaGVfaW5mby0+bGVuZ3RoKTsKICAgICAgICh2b2lkKSBUaHJvd01hZ2lja0V4Y2VwdGlvbihleGNlcHRpb24sR2V0TWFnaWNrTW9kdWxlKCksQ2FjaGVFcnJvciwKICAgICAgICAgIkNhY2hlUmVzb3VyY2VzRXhoYXVzdGVkIiwiYCVzJyIsaW1hZ2UtPmZpbGVuYW1lKTsKICAgICAgIHJldHVybihNYWdpY2tGYWxzZSk7CkBAIC0zNzM3LDYgKzM3MjYsNyBAQCBzdGF0aWMgTWFnaWNrQm9vbGVhblR5cGUgT3BlblBpeGVsQ2FjaGUoSW1hZ2UgKmltYWdlLGNvbnN0IE1hcE1vZGUgbW9kZSwKICAgICAgICAgICAgICAgcmV0dXJuKHN0YXR1cyA9PSAwID8gTWFnaWNrRmFsc2UgOiBNYWdpY2tUcnVlKTsKICAgICAgICAgICAgIH0KICAgICAgICAgfQorICAgICAgUmVsaW5xdWlzaE1hZ2lja1Jlc291cmNlKE1hcFJlc291cmNlLGNhY2hlX2luZm8tPmxlbmd0aCk7CiAgICAgfQogICBzdGF0dXM9TWFnaWNrVHJ1ZTsKICAgaWYgKChzb3VyY2VfaW5mby5zdG9yYWdlX2NsYXNzICE9IFVuZGVmaW5lZENsYXNzKSAmJiAobW9kZSAhPSBSZWFkTW9kZSkpCkBAIC0zODQ0LDEzICszODM0LDYgQEAgTWFnaWNrRXhwb3J0IE1hZ2lja0Jvb2xlYW5UeXBlIFBlcnNpc3RQaXhlbENhY2hlKEltYWdlICppbWFnZSwKICAgLyoKICAgICBDbG9uZSBwZXJzaXN0ZW50IHBpeGVsIGNhY2hlLgogICAqLwotICBzdGF0dXM9QWNxdWlyZU1hZ2lja1Jlc291cmNlKERpc2tSZXNvdXJjZSxjYWNoZV9pbmZvLT5sZW5ndGgpOwotICBpZiAoc3RhdHVzID09IE1hZ2lja0ZhbHNlKQotICAgIHsKLSAgICAgICh2b2lkKSBUaHJvd01hZ2lja0V4Y2VwdGlvbihleGNlcHRpb24sR2V0TWFnaWNrTW9kdWxlKCksQ2FjaGVFcnJvciwKLSAgICAgICAgIkNhY2hlUmVzb3VyY2VzRXhoYXVzdGVkIiwiYCVzJyIsaW1hZ2UtPmZpbGVuYW1lKTsKLSAgICAgIHJldHVybihNYWdpY2tGYWxzZSk7Ci0gICAgfQogICBjbG9uZV9pbmZvPShDYWNoZUluZm8gKikgQ2xvbmVQaXhlbENhY2hlKGNhY2hlX2luZm8pOwogICBjbG9uZV9pbmZvLT50eXBlPURpc2tDYWNoZTsKICAgKHZvaWQpIENvcHlNYWdpY2tTdHJpbmcoY2xvbmVfaW5mby0+Y2FjaGVfZmlsZW5hbWUsZmlsZW5hbWUsTWFnaWNrUGF0aEV4dGVudCk7CmRpZmYgLS1naXQgYS9NYWdpY2tDb3JlL21hdHJpeC5jIGIvTWFnaWNrQ29yZS9tYXRyaXguYwppbmRleCAyZGY2YjU1MGEuLmU4M2JhZWNiMSAxMDA2NDQKLS0tIGEvTWFnaWNrQ29yZS9tYXRyaXguYworKysgYi9NYWdpY2tDb3JlL21hdHJpeC5jCkBAIC0zMzEsMTIgKzMzMSwxMiBAQCBNYWdpY2tFeHBvcnQgZG91YmxlICoqQWNxdWlyZU1hZ2lja01hdHJpeChjb25zdCBzaXplX3QgbnVtYmVyX3Jvd3MsCiAgIHsKICAgICBtYXRyaXhbaV09KGRvdWJsZSAqKSBBY3F1aXJlUXVhbnR1bU1lbW9yeShzaXplLHNpemVvZigqbWF0cml4W2ldKSk7CiAgICAgaWYgKG1hdHJpeFtpXSA9PSAoZG91YmxlICopIE5VTEwpCi0gICAgICB7Ci0gICAgICAgIGZvciAoaj0wOyBqIDwgaTsgaisrKQotICAgICAgICAgIG1hdHJpeFtqXT0oZG91YmxlICopIFJlbGlucXVpc2hNYWdpY2tNZW1vcnkobWF0cml4W2pdKTsKLSAgICAgICAgbWF0cml4PShkb3VibGUgKiopIFJlbGlucXVpc2hNYWdpY2tNZW1vcnkobWF0cml4KTsKLSAgICAgICAgcmV0dXJuKChkb3VibGUgKiopIE5VTEwpOwotICAgICAgfQorICAgIHsKKyAgICAgIGZvciAoaj0wOyBqIDwgaTsgaisrKQorICAgICAgICBtYXRyaXhbal09KGRvdWJsZSAqKSBSZWxpbnF1aXNoTWFnaWNrTWVtb3J5KG1hdHJpeFtqXSk7CisgICAgICBtYXRyaXg9KGRvdWJsZSAqKikgUmVsaW5xdWlzaE1hZ2lja01lbW9yeShtYXRyaXgpOworICAgICAgcmV0dXJuKChkb3VibGUgKiopIE5VTEwpOworICAgIH0KICAgICBmb3IgKGo9MDsgaiA8IChzc2l6ZV90KSBzaXplOyBqKyspCiAgICAgICBtYXRyaXhbaV1bal09MC4wOwogICB9CkBAIC0xMDcxLDcgKzEwNzEsNyBAQCBNYWdpY2tFeHBvcnQgZG91YmxlICoqUmVsaW5xdWlzaE1hZ2lja01hdHJpeChkb3VibGUgKiptYXRyaXgsCiAgIGlmIChtYXRyaXggPT0gKGRvdWJsZSAqKikgTlVMTCApCiAgICAgcmV0dXJuKG1hdHJpeCk7CiAgIGZvciAoaT0wOyBpIDwgKHNzaXplX3QpIG51bWJlcl9yb3dzOyBpKyspCi0gICAgbWF0cml4W2ldPShkb3VibGUgKikgUmVsaW5xdWlzaE1hZ2lja01lbW9yeShtYXRyaXhbaV0pOworICAgICBtYXRyaXhbaV09KGRvdWJsZSAqKSBSZWxpbnF1aXNoTWFnaWNrTWVtb3J5KG1hdHJpeFtpXSk7CiAgIG1hdHJpeD0oZG91YmxlICoqKSBSZWxpbnF1aXNoTWFnaWNrTWVtb3J5KG1hdHJpeCk7CiAgIHJldHVybihtYXRyaXgpOwogfQpkaWZmIC0tZ2l0IGEvTWFnaWNrQ29yZS9vcGVuY2wuYyBiL01hZ2lja0NvcmUvb3BlbmNsLmMKaW5kZXggNjRjNTRmMDI0Li4zMTNkZjE3OTkgMTAwNjQ0Ci0tLSBhL01hZ2lja0NvcmUvb3BlbmNsLmMKKysrIGIvTWFnaWNrQ29yZS9vcGVuY2wuYwpAQCAtMjg5NCw2ICsyODk0LDcgQEAgc3RhdGljIHZvaWQgQ0xfQVBJX0NBTEwgRGVzdHJveU1hZ2lja0NMQ2FjaGVJbmZvQW5kUGl4ZWxzKAogICAgICAgfQogICB9CiAgIHBpeGVscz1pbmZvLT5waXhlbHM7CisgIFJlbGlucXVpc2hNYWdpY2tSZXNvdXJjZShNZW1vcnlSZXNvdXJjZSxpbmZvLT5sZW5ndGgpOwogICBEZXN0cm95TWFnaWNrQ0xDYWNoZUluZm8oaW5mbyk7CiAgICh2b2lkKSBSZWxpbnF1aXNoQWxpZ25lZE1lbW9yeShwaXhlbHMpOwogfQpkaWZmIC0tZ2l0IGEvTWFnaWNrQ29yZS9yZWdpc3RyeS5jIGIvTWFnaWNrQ29yZS9yZWdpc3RyeS5jCmluZGV4IGIwYWQ4NTY2Ni4uMmUxNTlmN2Y4IDEwMDY0NAotLS0gYS9NYWdpY2tDb3JlL3JlZ2lzdHJ5LmMKKysrIGIvTWFnaWNrQ29yZS9yZWdpc3RyeS5jCkBAIC0xOTksNyArMTk5LDExIEBAIE1hZ2lja0V4cG9ydCB2b2lkICpHZXRJbWFnZVJlZ2lzdHJ5KGNvbnN0IFJlZ2lzdHJ5VHlwZSB0eXBlLGNvbnN0IGNoYXIgKmtleSwKICAgICByZXR1cm4oKHZvaWQgKikgTlVMTCk7CiAgIHJlZ2lzdHJ5X2luZm89KFJlZ2lzdHJ5SW5mbyAqKSBHZXRWYWx1ZUZyb21TcGxheVRyZWUocmVnaXN0cnksa2V5KTsKICAgaWYgKHJlZ2lzdHJ5X2luZm8gPT0gKHZvaWQgKikgTlVMTCkKLSAgICByZXR1cm4oKHZvaWQgKikgTlVMTCk7CisgICAgeworICAgICAgKHZvaWQpIFRocm93TWFnaWNrRXhjZXB0aW9uKGV4Y2VwdGlvbixHZXRNYWdpY2tNb2R1bGUoKSxSZWdpc3RyeUVycm9yLAorICAgICAgICAiVW5hYmxlVG9HZXRSZWdpc3RyeUlEIiwiYCVzJyIsa2V5KTsKKyAgICAgIHJldHVybigodm9pZCAqKSBOVUxMKTsKKyAgICB9CiAgIHZhbHVlPSh2b2lkICopIE5VTEw7CiAgIHN3aXRjaCAodHlwZSkKICAgewpkaWZmIC0tZ2l0IGEvTWFnaWNrQ29yZS9yZXNvdXJjZS5jIGIvTWFnaWNrQ29yZS9yZXNvdXJjZS5jCmluZGV4IDk0NTNkMzc1ZC4uYTY1YzVhMzI4IDEwMDY0NAotLS0gYS9NYWdpY2tDb3JlL3Jlc291cmNlLmMKKysrIGIvTWFnaWNrQ29yZS9yZXNvdXJjZS5jCkBAIC0yMTAsNyArMjEwLDcgQEAgTWFnaWNrRXhwb3J0IE1hZ2lja0Jvb2xlYW5UeXBlIEFjcXVpcmVNYWdpY2tSZXNvdXJjZShjb25zdCBSZXNvdXJjZVR5cGUgdHlwZSwKICAgICAgIHJlc291cmNlX2luZm8ubWVtb3J5Kz0oTWFnaWNrT2Zmc2V0VHlwZSkgc2l6ZTsKICAgICAgIGxpbWl0PXJlc291cmNlX2luZm8ubWVtb3J5X2xpbWl0OwogICAgICAgaWYgKChsaW1pdCA9PSBNYWdpY2tSZXNvdXJjZUluZmluaXR5KSB8fAotICAgICAgICAgIChyZXNvdXJjZV9pbmZvLm1lbW9yeSA8IChNYWdpY2tPZmZzZXRUeXBlKSBsaW1pdCkpCisgICAgICAgICAgKChNYWdpY2tTaXplVHlwZSkgcmVzb3VyY2VfaW5mby5tZW1vcnkgPCBsaW1pdCkpCiAgICAgICAgIHN0YXR1cz1NYWdpY2tUcnVlOwogICAgICAgZWxzZQogICAgICAgICByZXNvdXJjZV9pbmZvLm1lbW9yeS09KE1hZ2lja09mZnNldFR5cGUpIHNpemU7CkBAIC0yMzAsNyArMjMwLDcgQEAgTWFnaWNrRXhwb3J0IE1hZ2lja0Jvb2xlYW5UeXBlIEFjcXVpcmVNYWdpY2tSZXNvdXJjZShjb25zdCBSZXNvdXJjZVR5cGUgdHlwZSwKICAgICAgIHJlc291cmNlX2luZm8ubWFwKz0oTWFnaWNrT2Zmc2V0VHlwZSkgc2l6ZTsKICAgICAgIGxpbWl0PXJlc291cmNlX2luZm8ubWFwX2xpbWl0OwogICAgICAgaWYgKChsaW1pdCA9PSBNYWdpY2tSZXNvdXJjZUluZmluaXR5KSB8fAotICAgICAgICAgIChyZXNvdXJjZV9pbmZvLm1hcCA8IChNYWdpY2tPZmZzZXRUeXBlKSBsaW1pdCkpCisgICAgICAgICAgKChNYWdpY2tTaXplVHlwZSkgcmVzb3VyY2VfaW5mby5tYXAgPCBsaW1pdCkpCiAgICAgICAgIHN0YXR1cz1NYWdpY2tUcnVlOwogICAgICAgZWxzZQogICAgICAgICByZXNvdXJjZV9pbmZvLm1hcC09KE1hZ2lja09mZnNldFR5cGUpIHNpemU7CkBAIC0yNTAsNyArMjUwLDcgQEAgTWFnaWNrRXhwb3J0IE1hZ2lja0Jvb2xlYW5UeXBlIEFjcXVpcmVNYWdpY2tSZXNvdXJjZShjb25zdCBSZXNvdXJjZVR5cGUgdHlwZSwKICAgICAgIHJlc291cmNlX2luZm8uZGlzays9KE1hZ2lja09mZnNldFR5cGUpIHNpemU7CiAgICAgICBsaW1pdD1yZXNvdXJjZV9pbmZvLmRpc2tfbGltaXQ7CiAgICAgICBpZiAoKGxpbWl0ID09IE1hZ2lja1Jlc291cmNlSW5maW5pdHkpIHx8Ci0gICAgICAgICAgKHJlc291cmNlX2luZm8uZGlzayA8IChNYWdpY2tPZmZzZXRUeXBlKSBsaW1pdCkpCisgICAgICAgICAgKChNYWdpY2tTaXplVHlwZSkgcmVzb3VyY2VfaW5mby5kaXNrIDwgbGltaXQpKQogICAgICAgICBzdGF0dXM9TWFnaWNrVHJ1ZTsKICAgICAgIGVsc2UKICAgICAgICAgcmVzb3VyY2VfaW5mby5kaXNrLT0oTWFnaWNrT2Zmc2V0VHlwZSkgc2l6ZTsKQEAgLTI3MCw3ICsyNzAsNyBAQCBNYWdpY2tFeHBvcnQgTWFnaWNrQm9vbGVhblR5cGUgQWNxdWlyZU1hZ2lja1Jlc291cmNlKGNvbnN0IFJlc291cmNlVHlwZSB0eXBlLAogICAgICAgcmVzb3VyY2VfaW5mby5maWxlKz0oTWFnaWNrT2Zmc2V0VHlwZSkgc2l6ZTsKICAgICAgIGxpbWl0PXJlc291cmNlX2luZm8uZmlsZV9saW1pdDsKICAgICAgIGlmICgobGltaXQgPT0gTWFnaWNrUmVzb3VyY2VJbmZpbml0eSkgfHwKLSAgICAgICAgICAocmVzb3VyY2VfaW5mby5maWxlIDwgKE1hZ2lja09mZnNldFR5cGUpIGxpbWl0KSkKKyAgICAgICAgICAoKE1hZ2lja1NpemVUeXBlKSByZXNvdXJjZV9pbmZvLmZpbGUgPCBsaW1pdCkpCiAgICAgICAgIHN0YXR1cz1NYWdpY2tUcnVlOwogICAgICAgZWxzZQogICAgICAgICByZXNvdXJjZV9pbmZvLmZpbGUtPShNYWdpY2tPZmZzZXRUeXBlKSBzaXplOwpAQCAtMzA3LDcgKzMwNyw3IEBAIE1hZ2lja0V4cG9ydCBNYWdpY2tCb29sZWFuVHlwZSBBY3F1aXJlTWFnaWNrUmVzb3VyY2UoY29uc3QgUmVzb3VyY2VUeXBlIHR5cGUsCiAgICAgewogICAgICAgbGltaXQ9cmVzb3VyY2VfaW5mby50aHJlYWRfbGltaXQ7CiAgICAgICBpZiAoKGxpbWl0ID09IE1hZ2lja1Jlc291cmNlSW5maW5pdHkpIHx8Ci0gICAgICAgICAgKHJlc291cmNlX2luZm8udGhyZWFkIDwgKE1hZ2lja09mZnNldFR5cGUpIGxpbWl0KSkKKyAgICAgICAgICAoKE1hZ2lja1NpemVUeXBlKSByZXNvdXJjZV9p\n[... Observation truncated due to length ...]\nc2l6ZV90IGNoYW5uZWxzLAogICAgIH0KICAgaWYgKFJlYWRCbG9iKGltYWdlLGNvbXBhY3Rfc2l6ZSxjb21wYWN0X3BpeGVscykgIT0gKHNzaXplX3QpIGNvbXBhY3Rfc2l6ZSkKICAgICB7Ci0gICAgICBwaXhlbHM9KHVuc2lnbmVkIGNoYXIgKikgUmVsaW5xdWlzaE1hZ2lja01lbW9yeShwaXhlbHMpOwogICAgICAgY29tcGFjdF9waXhlbHM9KHVuc2lnbmVkIGNoYXIgKikgUmVsaW5xdWlzaE1hZ2lja01lbW9yeShjb21wYWN0X3BpeGVscyk7CiAgICAgICBUaHJvd0JpbmFyeUV4Y2VwdGlvbihDb3JydXB0SW1hZ2VFcnJvciwiVW5leHBlY3RlZEVuZE9mRmlsZSIsCiAgICAgICAgIGltYWdlLT5maWxlbmFtZSk7CkBAIC0xMjY0LDYgKzEyNjMsOCBAQCBzdGF0aWMgTWFnaWNrQm9vbGVhblR5cGUgUmVhZFBTRENoYW5uZWxaaXAoSW1hZ2UgKmltYWdlLGNvbnN0IHNpemVfdCBjaGFubmVscywKICAgICAgIHsKICAgICAgICAgcmV0PWluZmxhdGUoJnN0cmVhbSxaX1NZTkNfRkxVU0gpOwogICAgICAgICBpZiAoKHJldCAhPSBaX09LKSAmJiAocmV0ICE9IFpfU1RSRUFNX0VORCkpCisgICAgICAgICAgYnJlYWs7CisgICAgICAgIGlmIChyZXQgPT0gWl9TVFJFQU1fRU5EKQogICAgICAgICAgIHsKICAgICAgICAgICAgICh2b2lkKSBpbmZsYXRlRW5kKCZzdHJlYW0pOwogICAgICAgICAgICAgY29tcGFjdF9waXhlbHM9KHVuc2lnbmVkIGNoYXIgKikgUmVsaW5xdWlzaE1hZ2lja01lbW9yeSgKQEAgLTEyNzEsMzMgKzEyNzIsMzEgQEAgc3RhdGljIE1hZ2lja0Jvb2xlYW5UeXBlIFJlYWRQU0RDaGFubmVsWmlwKEltYWdlICppbWFnZSxjb25zdCBzaXplX3QgY2hhbm5lbHMsCiAgICAgICAgICAgICBwaXhlbHM9KHVuc2lnbmVkIGNoYXIgKikgUmVsaW5xdWlzaE1hZ2lja01lbW9yeShwaXhlbHMpOwogICAgICAgICAgICAgcmV0dXJuKE1hZ2lja0ZhbHNlKTsKICAgICAgICAgICB9Ci0gICAgICAgIGlmIChyZXQgPT0gWl9TVFJFQU1fRU5EKQotICAgICAgICAgIGJyZWFrOwogICAgICAgfQogICAgICAgKHZvaWQpIGluZmxhdGVFbmQoJnN0cmVhbSk7CiAgICAgfQogCiAgIGlmIChjb21wcmVzc2lvbiA9PSBaaXBXaXRoUHJlZGljdGlvbikKLSAgICB7Ci0gICAgICBwPXBpeGVsczsKLSAgICAgIHdoaWxlIChjb3VudCA+IDApCi0gICAgICB7Ci0gICAgICAgIGxlbmd0aD1pbWFnZS0+Y29sdW1uczsKLSAgICAgICAgd2hpbGUgKC0tbGVuZ3RoKQotICAgICAgICB7Ci0gICAgICAgICAgaWYgKHBhY2tldF9zaXplID09IDIpCi0gICAgICAgICAgICB7Ci0gICAgICAgICAgICAgIHBbMl0rPXBbMF0rKChwWzFdK3BbM10pID4+IDgpOwotICAgICAgICAgICAgICBwWzNdKz1wWzFdOwotICAgICAgICAgICAgfQotICAgICAgICAgIGVsc2UKLSAgICAgICAgICAgICoocCsxKSs9KnA7Ci0gICAgICAgICAgcCs9cGFja2V0X3NpemU7Ci0gICAgICAgIH0KLSAgICAgICAgcCs9cGFja2V0X3NpemU7Ci0gICAgICAgIGNvdW50LT1yb3dfc2l6ZTsKLSAgICAgIH0KLSAgICB9CisgIHsKKyAgICAgcD1waXhlbHM7CisgICAgIHdoaWxlIChjb3VudCA+IDApCisgICAgIHsKKyAgICAgICBsZW5ndGg9aW1hZ2UtPmNvbHVtbnM7CisgICAgICAgd2hpbGUgKC0tbGVuZ3RoKQorICAgICAgIHsKKyAgICAgICAgIGlmIChwYWNrZXRfc2l6ZSA9PSAyKQorICAgICAgICAgICB7CisgICAgICAgICAgICAgcFsyXSs9cFswXSsoKHBbMV0rcFszXSkgPj4gOCk7CisgICAgICAgICAgICAgcFszXSs9cFsxXTsKKyAgICAgICAgICAgfQorICAgICAgICAgZWxzZQorICAgICAgICAgICoocCsxKSs9KnA7CisgICAgICAgICBwKz1wYWNrZXRfc2l6ZTsKKyAgICAgICB9CisgICAgICAgcCs9cGFja2V0X3NpemU7CisgICAgICAgY291bnQtPXJvd19zaXplOworICAgICB9CisgIH0KIAogICBzdGF0dXM9TWFnaWNrVHJ1ZTsKICAgcD1waXhlbHM7CmRpZmYgLS1naXQgYS9jb2RlcnMvc3ZnLmMgYi9jb2RlcnMvc3ZnLmMKaW5kZXggYzNlNzM0MTVjLi4zMTkwYjVjZDUgMTAwNjQ0Ci0tLSBhL2NvZGVycy9zdmcuYworKysgYi9jb2RlcnMvc3ZnLmMKQEAgLTMwODEsMTEgKzMwODEsOCBAQCBzdGF0aWMgSW1hZ2UgKlJlYWRTVkdJbWFnZShjb25zdCBJbWFnZUluZm8gKmltYWdlX2luZm8sRXhjZXB0aW9uSW5mbyAqZXhjZXB0aW9uKQogICAgICAgICAgICAgY2Fpcm9fc3VyZmFjZT1jYWlyb19pbWFnZV9zdXJmYWNlX2NyZWF0ZV9mb3JfZGF0YShwaXhlbHMsCiAgICAgICAgICAgICAgIENBSVJPX0ZPUk1BVF9BUkdCMzIsKGludCkgaW1hZ2UtPmNvbHVtbnMsKGludCkgaW1hZ2UtPnJvd3MsKGludCkKICAgICAgICAgICAgICAgc3RyaWRlKTsKLSAgICAgICAgICAgIGlmICgoY2Fpcm9fc3VyZmFjZSA9PSAoY2Fpcm9fc3VyZmFjZV90ICopIE5VTEwpIHx8Ci0gICAgICAgICAgICAgICAgKGNhaXJvX3N1cmZhY2Vfc3RhdHVzKGNhaXJvX3N1cmZhY2UpICE9IENBSVJPX1NUQVRVU19TVUNDRVNTKSkKKyAgICAgICAgICAgIGlmIChjYWlyb19zdXJmYWNlID09IChjYWlyb19zdXJmYWNlX3QgKikgTlVMTCkKICAgICAgICAgICAgICAgewotICAgICAgICAgICAgICAgIGlmIChjYWlyb19zdXJmYWNlICE9IChjYWlyb19zdXJmYWNlX3QgKikgTlVMTCkKLSAgICAgICAgICAgICAgICAgIGNhaXJvX3N1cmZhY2VfZGVzdHJveShjYWlyb19zdXJmYWNlKTsKICAgICAgICAgICAgICAgICBwaXhlbF9pbmZvPVJlbGlucXVpc2hWaXJ0dWFsTWVtb3J5KHBpeGVsX2luZm8pOwogICAgICAgICAgICAgICAgIGdfb2JqZWN0X3VucmVmKHN2Z19oYW5kbGUpOwogICAgICAgICAgICAgICAgIFRocm93UmVhZGVyRXhjZXB0aW9uKFJlc291cmNlTGltaXRFcnJvciwKZGlmZiAtLWdpdCBhL2NvZGVycy93cGcuYyBiL2NvZGVycy93cGcuYwppbmRleCA4MjIzMjI5ZTUuLmVhZDNmNDYwZCAxMDA2NDQKLS0tIGEvY29kZXJzL3dwZy5jCisrKyBiL2NvZGVycy93cGcuYwpAQCAtMzU3LDExICszNTcsMTEgQEAgc3RhdGljIE1hZ2lja0Jvb2xlYW5UeXBlIEluc2VydFJvdyhJbWFnZSAqaW1hZ2UsdW5zaWduZWQgY2hhciAqcCxzc2l6ZV90IHksCiAgICAgICAgICAgfQogICAgICAgICBicmVhazsKICAgICAgIH0KLQorIAogICAgIGNhc2UgNDogIC8qIENvbnZlcnQgUHNldWRvQ29sb3Igc2NhbmxpbmUuICovCiAgICAgICB7CiAgICAgICAgIGZvciAoeD0wOyB4IDwgKChzc2l6ZV90KSBpbWFnZS0+Y29sdW1ucy0xKTsgeCs9MikKLSAgICAgICAgICB7CisgICAgICAgICAgeyAKICAgICAgICAgICAgIGluZGV4PUNvbnN0cmFpbkNvbG9ybWFwSW5kZXgoaW1hZ2UsKCpwID4+IDQpICYgMHgwZixleGNlcHRpb24pOwogICAgICAgICAgICAgU2V0UGl4ZWxJbmRleChpbWFnZSxpbmRleCxxKTsKICAgICAgICAgICAgIFNldFBpeGVsVmlhUGl4ZWxJbmZvKGltYWdlLGltYWdlLT5jb2xvcm1hcCsoc3NpemVfdCkgaW5kZXgscSk7CkBAIC0zOTQsNyArMzk0LDcgQEAgc3RhdGljIE1hZ2lja0Jvb2xlYW5UeXBlIEluc2VydFJvdyhJbWFnZSAqaW1hZ2UsdW5zaWduZWQgY2hhciAqcCxzc2l6ZV90IHksCiAgICAgICAgICAgfQogICAgICAgfQogICAgICAgYnJlYWs7Ci0KKyAgICAgCiAgICAgY2FzZSAyNDogICAgIC8qICBDb252ZXJ0IERpcmVjdENvbG9yIHNjYW5saW5lLiAgKi8KICAgICAgIGZvciAoeD0wOyB4IDwgKHNzaXplX3QpIGltYWdlLT5jb2x1bW5zOyB4KyspCiAgICAgICAgIHsKQEAgLTYwNCw3ICs2MDQsNyBAQCBzdGF0aWMgaW50IFVucGFja1dQRzJSYXN0ZXIoSW1hZ2UgKmltYWdlLGludCBicHAsRXhjZXB0aW9uSW5mbyAqZXhjZXB0aW9uKQogICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgZm9yKGk9MDsgaTw9IFJ1bkNvdW50O2krKykKICAgICAgICAgICAgIGZvcihiYnVmPTA7IGJidWYgPCBTYW1wbGVTaXplOyBiYnVmKyspCi0gICAgICAgICAgICAgIEluc2VydEJ5dGU2KFNhbXBsZUJ1ZmZlcltiYnVmXSk7CisgICAgICAgICAgICAgIEluc2VydEJ5dGU2KFNhbXBsZUJ1ZmZlcltiYnVmXSk7ICAgICAgICAgIAogICAgICAgICAgIGJyZWFrOwogICAgICAgICBjYXNlIDB4RkU6CiAgICAgICAgICAgUnVuQ291bnQ9UmVhZEJsb2JCeXRlKGltYWdlKTsgIC8qIFJTVCAqLwpAQCAtNjQwLDcgKzY0MCw3IEBAIHN0YXRpYyBpbnQgVW5wYWNrV1BHMlJhc3RlcihJbWFnZSAqaW1hZ2UsaW50IGJwcCxFeGNlcHRpb25JbmZvICpleGNlcHRpb24pCiAgICAgICAgICAgUnVuQ291bnQ9YmJ1ZiAmIDB4N0Y7CiAKICAgICAgICAgICBpZihiYnVmICYgMHg4MCkgICAgIC8qIFJFUCAqLwotICAgICAgICAgICAgeworICAgICAgICAgICAgeyAgCiAgICAgICAgICAgICAgIGZvcihpPTA7IGkgPCBTYW1wbGVTaXplOyBpKyspCiAgICAgICAgICAgICAgICAgU2FtcGxlQnVmZmVyW2ldPVJlYWRCbG9iQnl0ZShpbWFnZSk7CiAgICAgICAgICAgICAgIGZvcihpPTA7aTw9UnVuQ291bnQ7aSsrKQpAQCAtNzMzLDcgKzczMyw3IEBAIHN0YXRpYyBJbWFnZSAqRXh0cmFjdFBvc3RzY3JpcHQoSW1hZ2UgKmltYWdlLGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKICAgICBwb3N0c2NyaXB0X2ZpbGVbTWFnaWNrUGF0aEV4dGVudF07CiAKICAgY29uc3QgTWFnaWNJbmZvCi0gICAgKm1hZ2ljX2luZm87CisgICAgKm1hZ2ljX2luZm87ICAgIAogCiAgIEZJTEUKICAgICAqcHNfZmlsZTsKQEAgLTc0MywxMyArNzQzLDEzIEBAIHN0YXRpYyBJbWFnZSAqRXh0cmFjdFBvc3RzY3JpcHQoSW1hZ2UgKmltYWdlLGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKIAogICBJbWFnZUluZm8KICAgICAqY2xvbmVfaW5mbzsKLQorICAgIAogICBJbWFnZQogICAgICppbWFnZTI7Ci0KKyAgICAKICAgdW5zaWduZWQgY2hhcgotICAgIG1hZ2lja1syKk1hZ2lja1BhdGhFeHRlbnRdOwotCisgICAgbWFnaWNrWzIqTWFnaWNrUGF0aEV4dGVudF07ICAgIAorICAgIAogCiAgIGlmICgoY2xvbmVfaW5mbz1DbG9uZUltYWdlSW5mbyhpbWFnZV9pbmZvKSkgPT0gTlVMTCkKICAgICByZXR1cm4oaW1hZ2UpOwpAQCAtNzY1LDcgKzc2NSw3IEBAIHN0YXRpYyBJbWFnZSAqRXh0cmFjdFBvc3RzY3JpcHQoSW1hZ2UgKmltYWdlLGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKICAgLyogQ29weSBwb3N0c2NyaXB0IHRvIHRlbXBvcmFyeSBmaWxlICovCiAgICh2b2lkKSBTZWVrQmxvYihpbWFnZSxQU19PZmZzZXQsU0VFS19TRVQpOwogICAodm9pZCkgUmVhZEJsb2IoaW1hZ2UsIDIqTWFnaWNrUGF0aEV4dGVudCwgbWFnaWNrKTsKLQorICAKICAgKHZvaWQpIFNlZWtCbG9iKGltYWdlLFBTX09mZnNldCxTRUVLX1NFVCk7CiAgIHdoaWxlIChQU19TaXplLS0gPiAwKQogICB7CkBAIC03NzUsMTYgKzc3NSwxNiBAQCBzdGF0aWMgSW1hZ2UgKkV4dHJhY3RQb3N0c2NyaXB0KEltYWdlICppbWFnZSxjb25zdCBJbWFnZUluZm8gKmltYWdlX2luZm8sCiAgICAgKHZvaWQpIGZwdXRjKGMscHNfZmlsZSk7CiAgIH0KICAgKHZvaWQpIGZjbG9zZShwc19maWxlKTsKLQorICAKICAgICAvKiBEZXRlY3QgZmlsZSBmb3JtYXQgLSBDaGVjayBtYWdpYy5tZ2sgY29uZmlndXJhdGlvbiBmaWxlLiAqLwogICBtYWdpY19pbmZvPUdldE1hZ2ljSW5mbyhtYWdpY2ssMipNYWdpY2tQYXRoRXh0ZW50LGV4Y2VwdGlvbik7CiAgIGlmKG1hZ2ljX2luZm8gPT0gKGNvbnN0IE1hZ2ljSW5mbyAqKSBOVUxMKSBnb3RvIEZJTklTSF9VTkw7CiAgIC8qICAgICBwcmludGYoIkRldGVjdGVkOiVzICBcbiIsbWFnaWNfaW5mby0+bmFtZSk7ICovCi0gIGlmKGV4Y2VwdGlvbi0+c2V2ZXJpdHkgIT0gVW5kZWZpbmVkRXhjZXB0aW9uKSBnb3RvIEZJTklTSF9VTkw7CisgIGlmKGV4Y2VwdGlvbi0+c2V2ZXJpdHkgIT0gVW5kZWZpbmVkRXhjZXB0aW9uKSBnb3RvIEZJTklTSF9VTkw7ICAgICAKICAgaWYobWFnaWNfaW5mby0+bmFtZSA9PSAoY2hhciAqKSBOVUxMKSBnb3RvIEZJTklTSF9VTkw7Ci0KKyAgICAKICAgKHZvaWQpIHN0cm5jcHkoY2xvbmVfaW5mby0+bWFnaWNrLG1hZ2ljX2luZm8tPm5hbWUsTWFnaWNrUGF0aEV4dGVudC0xKTsKLQorICAKICAgICAvKiBSZWFkIG5lc3RlZCBpbWFnZSAqLwogICAvKkZvcm1hdFN0cmluZyhjbG9uZV9pbmZvLT5maWxlbmFtZSwiJXM6JXMiLG1hZ2ljX2luZm8tPm5hbWUscG9zdHNjcmlwdF9maWxlKTsqLwogICBGb3JtYXRMb2NhbGVTdHJpbmcoY2xvbmVfaW5mby0+ZmlsZW5hbWUsTWFnaWNrUGF0aEV4dGVudCwiJXMiLHBvc3RzY3JpcHRfZmlsZSk7CkBAIC04MDksNyArODA5LDcgQEAgc3RhdGljIEltYWdlICpFeHRyYWN0UG9zdHNjcmlwdChJbWFnZSAqaW1hZ2UsY29uc3QgSW1hZ2VJbmZvICppbWFnZV9pbmZvLAogCiAgIEFwcGVuZEltYWdlVG9MaXN0KCZpbWFnZSxpbWFnZTIpOwogCi0gRklOSVNIX1VOTDoKKyBGSU5JU0hfVU5MOiAgICAKICAgKHZvaWQpIFJlbGlucXVpc2hVbmlxdWVGaWxlUmVzb3VyY2UocG9zdHNjcmlwdF9maWxlKTsKICBGSU5JU0g6CiAgIERlc3Ryb3lJbWFnZUluZm8oY2xvbmVfaW5mbyk7CkBAIC05MjQsNyArOTI0LDcgQEAgc3RhdGljIEltYWdlICpSZWFkV1BHSW1hZ2UoY29uc3QgSW1hZ2VJbmZvICppbWFnZV9pbmZvLAogICAgIHNpemVfdCBQU191bmtub3duMTsKICAgICB1bnNpZ25lZCBpbnQgUFNfdW5rbm93bjI7CiAgICAgdW5zaWduZWQgaW50IFBTX3Vua25vd24zOwotICB9IFdQR1BTbDFSZWNvcmQ7CisgIH0gV1BHUFNsMVJlY29yZDsgIAogICAqLwogCiAgIEltYWdlCkBAIC0xMDc3LDEzICsxMDc3LDEzIEBAIHN0YXRpYyBJbWFnZSAqUmVhZFdQR0ltYWdlKGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKICAgICAgICAgICAgICAgICAgICAgUmVhZEJsb2JCeXRlKGltYWdlKSk7CiAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICBicmVhazsKLQorICAgICAKICAgICAgICAgICAgIGNhc2UgMHgxMTogIC8qIFN0YXJ0IFBTIGwxICovCiAgICAgICAgICAgICAgIGlmKFJlYy5SZWNvcmRMZW5ndGggPiA4KQogICAgICAgICAgICAgICAgIGltYWdlPUV4dHJhY3RQb3N0c2NyaXB0KGltYWdlLGltYWdlX2luZm8sCiAgICAgICAgICAgICAgICAgICBUZWxsQmxvYihpbWFnZSkrOCwgICAvKiBza2lwIFBTIGhlYWRlciBpbiB0aGUgd3BnICovCiAgICAgICAgICAgICAgICAgICAoc3NpemVfdCkgUmVjLlJlY29yZExlbmd0aC04LGV4Y2VwdGlvbik7Ci0gICAgICAgICAgICAgIGJyZWFrOworICAgICAgICAgICAgICBicmVhazsgICAgIAogCiAgICAgICAgICAgICBjYXNlIDB4MTQ6ICAvKiBiaXRtYXAgdHlwZSAyICovCiAgICAgICAgICAgICAgIEJpdG1hcEhlYWRlcjIuUm90QW5nbGU9UmVhZEJsb2JMU0JTaG9ydChpbWFnZSk7CkBAIC0xMTE1LDExICsxMTE1LDExIEBAIHN0YXRpYyBJbWFnZSAqUmVhZFdQR0ltYWdlKGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKICAgICAgICAgICAgICAgaW1hZ2UtPnJvd3M9Qml0bWFwSGVhZGVyMi5IZWlnaHQ7CiAgICAgICAgICAgICAgIGJwcD1CaXRtYXBIZWFkZXIyLkRlcHRoOwogCi0gICAgICAgICAgICBVbnBhY2tSYXN0ZXI6CisgICAgICAgICAgICBVbnBhY2tSYXN0ZXI6ICAgICAgCiAgICAgICAgICAgICAgIHN0YXR1cz1TZXRJbWFnZUV4dGVudChpbWFnZSxpbWFnZS0+Y29sdW1ucyxpbWFnZS0+cm93cyxleGNlcHRpb24pOwogICAgICAgICAgICAgICBpZiAoc3RhdHVzID09IE1hZ2lja0ZhbHNlKQogICAgICAgICAgICAgICAgIGJyZWFrOwotICAgICAgICAgICAgICBpZiAoKGltYWdlLT5zdG9yYWdlX2NsYXNzICE9IFBzZXVkb0NsYXNzKSAmJiAoYnBwIDwgMjQpKQorICAgICAgICAgICAgICBpZiAoKGltYWdlLT5zdG9yYWdlX2NsYXNzICE9IFBzZXVkb0NsYXNzKSAmJiAoYnBwICE9IDI0KSkKICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICBpbWFnZS0+Y29sb3JzPW9uZSA8PCBicHA7CiAgICAgICAgICAgICAgICAgICBpZiAoIUFjcXVpcmVJbWFnZUNvbG9ybWFwKGltYWdlLGltYWdlLT5jb2xvcnMsZXhjZXB0aW9uKSkKQEAgLTExMzAsNyArMTEzMCw3IEBAIHN0YXRpYyBJbWFnZSAqUmVhZFdQR0ltYWdlKGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgLyogcHJpbnRmKCJMb2FkIGRlZmF1bHQgY29sb3JtYXAgXG4iKTsgKi8KICAgICAgICAgICAgICAgICAgIGZvciAoaT0wOyAoaSA8IChpbnQpIGltYWdlLT5jb2xvcnMpICYmIChpIDwgMjU2KTsgaSsrKQotICAgICAgICAgICAgICAgICAgICB7CisgICAgICAgICAgICAgICAgICAgIHsgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICBpbWFnZS0+Y29sb3JtYXBbaV0ucmVkPVNjYWxlQ2hhclRvUXVhbnR1bShXUEcxX1BhbGV0dGVbaV0uUmVkKTsKICAgICAgICAgICAgICAgICAgICAgICBpbWFnZS0+Y29sb3JtYXBbaV0uZ3JlZW49U2NhbGVDaGFyVG9RdWFudHVtKFdQRzFfUGFsZXR0ZVtpXS5HcmVlbik7CiAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2UtPmNvbG9ybWFwW2ldLmJsdWU9U2NhbGVDaGFyVG9RdWFudHVtKFdQRzFfUGFsZXR0ZVtpXS5CbHVlKTsKQEAgLTExNDQsNyArMTE0NCw3IEBAIHN0YXRpYyBJbWFnZSAqUmVhZFdQR0ltYWdlKGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLT5jb2xvcm1hcCwoc2l6ZV90KSAob25lIDw8IGJwcCksCiAgICAgICAgICAgICAgICAgICAgICAgICBzaXplb2YoKmltYWdlLT5jb2xvcm1hcCkpOwogICAgICAgICAgICAgICAgIH0KLQorICAgICAgICAgIAogICAgICAgICAgICAgICBpZiAoYnBwID09IDEpCiAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgaWYoaW1hZ2UtPmNvbG9ybWFwWzBdLnJlZD09MCAmJgpAQCAtMTE1OCw3ICsxMTU4LDcgQEAgc3RhdGljIEltYWdlICpSZWFkV1BHSW1hZ2UoY29uc3QgSW1hZ2VJbmZvICppbWFnZV9pbmZvLAogICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2UtPmNvbG9ybWFwWzFdLmdyZWVuID0KICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLT5jb2xvcm1hcFsxXS5ibHVlID0gUXVhbnR1bVJhbmdlOwogICAgICAgICAgICAgICAgICAgICB9Ci0gICAgICAgICAgICAgICAgfQorICAgICAgICAgICAgICAgIH0gICAgICAKIAogICAgICAgICAgICAgICBpZihVbnBhY2tXUEdSYXN0ZXIoaW1hZ2UsYnBwLGV4Y2VwdGlvbikgPCAwKQogICAgICAgICAgICAgICAgIC8qIFRoZSByYXN0ZXIgY2Fubm90IGJlIHVucGFja2VkICovCkBAIC0xMTY4LDcgKzExNjgsNyBAQCBzdGF0aWMgSW1hZ2UgKlJlYWRXUEdJbWFnZShjb25zdCBJbWFnZUluZm8gKmltYWdlX2luZm8sCiAgICAgICAgICAgICAgICAgICAgIH0KIAogICAgICAgICAgICAgICBpZihSZWMuUmVjVHlwZT09MHgxNCAmJiBCaXRtYXBIZWFkZXIyLlJvdEFuZ2xlIT0wICYmICFpbWFnZV9pbmZvLT5waW5nKQotICAgICAgICAgICAgICAgIHsKKyAgICAgICAgICAgICAgICB7ICAKICAgICAgICAgICAgICAgICAgIC8qIGZsb3AgY29tbWFuZCAqLwogICAgICAgICAgICAgICAgICAgaWYoQml0bWFwSGVhZGVyMi5Sb3RBbmdsZSAmIDB4ODAwMCkKICAgICAgICAgICAgICAgICAgICAgewpAQCAtMTM2MCw3ICsxMzYwLDcgQEAgc3RhdGljIEltYWdlICpSZWFkV1BHSW1hZ2UoY29uc3QgSW1hZ2VJbmZvICppbWFnZV9pbmZvLAogICAgICAgICAgICAgICAgICAgICBpZiggVW5wYWNrV1BHMlJhc3RlcihpbWFnZSxicHAsZXhjZXB0aW9uKSA8IDApCiAgICAgICAgICAgICAgICAgICAgICAgZ290byBEZWNvbXByZXNzaW9uRmFpbGVkOwogICAgICAgICAgICAgICAgICAgICBicmVhazsKLSAgICAgICAgICAgICAgICAgIH0KKyAgICAgICAgICAgICAgICAgIH0gICAKICAgICAgICAgICAgICAgICB9CiAKICAgICAgICAgICAgICAgaWYoQ1RNWzBdWzBdPDAgJiYgIWltYWdlX2luZm8tPnBpbmcpCmRpZmYgLS1naXQgYS9jb2RlcnMveHBtLmMgYi9jb2RlcnMveHBtLmMKaW5kZXggMDIzZjU4YmMyLi4yNzM0YzFmZjUgMTAwNjQ0Ci0tLSBhL2NvZGVycy94cG0uYworKysgYi9jb2RlcnMveHBtLmMKQEAgLTM2Niw3ICszNjYsNiBAQCBzdGF0aWMgSW1hZ2UgKlJlYWRYUE1JbWFnZShjb25zdCBJbWFnZUluZm8gKmltYWdlX2luZm8sRXhjZXB0aW9uSW5mbyAqZXhjZXB0aW9uKQogICAgICh2b2lkICooKikodm9pZCAqKSkgTlVMTCk7CiAgIGlmIChBY3F1aXJlSW1hZ2VDb2xvcm1hcChpbWFnZSxpbWFnZS0+Y29sb3JzLGV4Y2VwdGlvbikgPT0gTWFnaWNrRmFsc2UpCiAgICAgewotICAgICAgeHBtX2NvbG9ycz1EZXN0cm95U3BsYXlUcmVlKHhwbV9jb2xvcnMpOwogICAgICAgeHBtX2J1ZmZlcj1EZXN0cm95U3RyaW5nKHhwbV9idWZmZXIpOwogICAgICAgVGhyb3dSZWFkZXJFeGNlcHRpb24oUmVzb3VyY2VMaW1pdEVycm9yLCJNZW1vcnlBbGxvY2F0aW9uRmFpbGVkIik7CiAgICAgfQpAQCAtNDMxLDExICs0MzAsNyBAQCBzdGF0aWMgSW1hZ2UgKlJlYWRYUE1JbWFnZShjb25zdCBJbWFnZUluZm8gKmltYWdlX2luZm8sRXhjZXB0aW9uSW5mbyAqZXhjZXB0aW9uKQogICAgICAgKi8KICAgICAgIHN0YXR1cz1TZXRJbWFnZUV4dGVudChpbWFnZSxpbWFnZS0+Y29sdW1ucyxpbWFnZS0+cm93cyxleGNlcHRpb24pOwogICAgICAgaWYgKHN0YXR1cyA9PSBNYWdpY2tGYWxzZSkKLSAgICAgICAgewotICAgICAgICAgIHhwbV9jb2xvcnM9RGVzdHJveVNwbGF5VHJlZSh4cG1fY29sb3JzKTsKLSAgICAgICAgICB4cG1fYnVmZmVyPURlc3Ryb3lTdHJpbmcoeHBtX2J1ZmZlcik7Ci0gICAgICAgICAgcmV0dXJuKERlc3Ryb3lJbWFnZUxpc3QoaW1hZ2UpKTsKLSAgICAgICAgfQorICAgICAgICByZXR1cm4oRGVzdHJveUltYWdlTGlzdChpbWFnZSkpOwogICAgICAgZm9yICh5PTA7IHkgPCAoc3NpemVfdCkgaW1hZ2UtPnJvd3M7IHkrKykKICAgICAgIHsKICAgICAgICAgcD1OZXh0WFBNTGluZShwKTsKZGlmZiAtLWdpdCBhL2NvbmZpZ3VyZSBiL2NvbmZpZ3VyZQppbmRleCBjMTc5NGZkMWYuLmM0YTJkM2RiNCAxMDA3NTUKLS0tIGEvY29uZmlndXJlCisrKyBiL2NvbmZpZ3VyZQpAQCAtNDU1OSw3ICs0NTU5LDcgQEAgTUFHSUNLX1BBVENITEVWRUxfVkVSU0lPTj0xMgogCiBNQUdJQ0tfVkVSU0lPTj03LjAuNy0xMgogCi1NQUdJQ0tfR0lUX1JFVklTSU9OPTIxNzg2OjBlZTQ0ZmNkYjoyMDE3MTEyNQorTUFHSUNLX0dJVF9SRVZJU0lPTj0yMTcxMTpiMDFkMjU4MWM6MjAxNzExMjAKIAogCiAjIFN1YnN0aXR1dGUgbGlicmFyeSB2ZXJzaW9uaW5nCg==",
      "Magick_png_read_raw_profile-heap-overflow": "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",
      "base_commit_hash": "NGI0ODRjOWNhMzVjNzhhODI4YzNjYTZhOGQwNzdhYzFjZTNmZGVjYg=="
    },
    "env": {},
    "base_commit_hash": "4b484c9ca35c78a828c3ca6a8d077ac1ce3fdecb",
    "patch": null,
    "repo_changes": "ZGlmZiAtLWdpdCBhL01hZ2lja0NvcmUvYmxvYi5jIGIvTWFnaWNrQ29yZS9ibG9iLmMKaW5kZXggYjI0ODFlOTU1Li5hMTI0YmFhNjIgMTAwNjQ0Ci0tLSBhL01hZ2lja0NvcmUvYmxvYi5jCisrKyBiL01hZ2lja0NvcmUvYmxvYi5jCkBAIC00NTQsMTUgKzQ1NCwxMSBAQCBNYWdpY2tFeHBvcnQgSW1hZ2UgKkJsb2JUb0ltYWdlKGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbyxjb25zdCB2b2lkICpibG9iLAogICAgIH0KICAgaWYgKEdldE1hZ2lja0Jsb2JTdXBwb3J0KG1hZ2lja19pbmZvKSAhPSBNYWdpY2tGYWxzZSkKICAgICB7Ci0gICAgICBjaGFyCi0gICAgICAgIGZpbGVuYW1lW01hZ2lja1BhdGhFeHRlbnRdOwotCiAgICAgICAvKgogICAgICAgICBOYXRpdmUgYmxvYiBzdXBwb3J0IGZvciB0aGlzIGltYWdlIGZvcm1hdC4KICAgICAgICovCi0gICAgICAodm9pZCkgQ29weU1hZ2lja1N0cmluZyhmaWxlbmFtZSxibG9iX2luZm8tPmZpbGVuYW1lLE1hZ2lja1BhdGhFeHRlbnQpOwogICAgICAgKHZvaWQpIEZvcm1hdExvY2FsZVN0cmluZyhibG9iX2luZm8tPmZpbGVuYW1lLE1hZ2lja1BhdGhFeHRlbnQsIiVzOiVzIiwKLSAgICAgICAgYmxvYl9pbmZvLT5tYWdpY2ssZmlsZW5hbWUpOworICAgICAgICBibG9iX2luZm8tPm1hZ2ljayxpbWFnZV9pbmZvLT5maWxlbmFtZSk7CiAgICAgICBpbWFnZT1SZWFkSW1hZ2UoYmxvYl9pbmZvLGV4Y2VwdGlvbik7CiAgICAgICBpZiAoaW1hZ2UgIT0gKEltYWdlICopIE5VTEwpCiAgICAgICAgICh2b2lkKSBEZXRhY2hCbG9iKGltYWdlLT5ibG9iKTsKQEAgLTc2OCwxNiArNzY0LDEyIEBAIE1hZ2lja0V4cG9ydCBJbWFnZSAqQ3VzdG9tU3RyZWFtVG9JbWFnZShjb25zdCBJbWFnZUluZm8gKmltYWdlX2luZm8sCiAgIGlmICgoR2V0TWFnaWNrQmxvYlN1cHBvcnQobWFnaWNrX2luZm8pICE9IE1hZ2lja0ZhbHNlKSB8fAogICAgICAgKGJsb2JfaW5mby0+Y3VzdG9tX3N0cmVhbSA9PSAoQ3VzdG9tU3RyZWFtSW5mbyAqKSBOVUxMKSkKICAgICB7Ci0gICAgICBjaGFyCi0gICAgICAgIGZpbGVuYW1lW01hZ2lja1BhdGhFeHRlbnRdOwotCiAgICAgICAvKgogICAgICAgICBOYXRpdmUgYmxvYiBzdXBwb3J0IGZvciB0aGlzIGltYWdlIGZvcm1hdCBvciBTZXRJbWFnZUluZm8gY2hhbmdlZCB0aGUKICAgICAgICAgYmxvYiB0byBhIGZpbGUuCiAgICAgICAqLwotICAgICAgKHZvaWQpIENvcHlNYWdpY2tTdHJpbmcoZmlsZW5hbWUsYmxvYl9pbmZvLT5maWxlbmFtZSxNYWdpY2tQYXRoRXh0ZW50KTsKICAgICAgICh2b2lkKSBGb3JtYXRMb2NhbGVTdHJpbmcoYmxvYl9pbmZvLT5maWxlbmFtZSxNYWdpY2tQYXRoRXh0ZW50LCIlczolcyIsCi0gICAgICAgIGJsb2JfaW5mby0+bWFnaWNrLGZpbGVuYW1lKTsKKyAgICAgICAgYmxvYl9pbmZvLT5tYWdpY2ssaW1hZ2VfaW5mby0+ZmlsZW5hbWUpOwogICAgICAgaW1hZ2U9UmVhZEltYWdlKGJsb2JfaW5mbyxleGNlcHRpb24pOwogICAgICAgaWYgKGltYWdlICE9IChJbWFnZSAqKSBOVUxMKQogICAgICAgICAodm9pZCkgQ2xvc2VCbG9iKGltYWdlKTsKQEAgLTQ2NzcsNiArNDY2OSwyOCBAQCBNYWdpY2tFeHBvcnQgTWFnaWNrT2Zmc2V0VHlwZSBTZWVrQmxvYihJbWFnZSAqaW1hZ2UsCiAgICAgICAgICAgYnJlYWs7CiAgICAgICAgIH0KICAgICAgIH0KKyAgICAgIGlmIChibG9iX2luZm8tPm9mZnNldCA8IChNYWdpY2tPZmZzZXRUeXBlKSAoKG9mZl90KSBibG9iX2luZm8tPmxlbmd0aCkpCisgICAgICAgIHsKKyAgICAgICAgICBibG9iX2luZm8tPmVvZj1NYWdpY2tGYWxzZTsKKyAgICAgICAgICBicmVhazsKKyAgICAgICAgfQorICAgICAgaWYgKGJsb2JfaW5mby0+b2Zmc2V0IDwgKE1hZ2lja09mZnNldFR5cGUpICgob2ZmX3QpIGJsb2JfaW5mby0+ZXh0ZW50KSkKKyAgICAgICAgYnJlYWs7CisgICAgICBpZiAoYmxvYl9pbmZvLT5tYXBwZWQgIT0gTWFnaWNrRmFsc2UpCisgICAgICAgIHsKKyAgICAgICAgICBibG9iX2luZm8tPmVvZj1NYWdpY2tUcnVlOworICAgICAgICAgIHJldHVybigtMSk7CisgICAgICAgIH0KKyAgICAgIGJsb2JfaW5mby0+ZXh0ZW50PShzaXplX3QpIChibG9iX2luZm8tPm9mZnNldCtibG9iX2luZm8tPnF1YW50dW0pOworICAgICAgYmxvYl9pbmZvLT5xdWFudHVtPDw9MTsKKyAgICAgIGJsb2JfaW5mby0+ZGF0YT0odW5zaWduZWQgY2hhciAqKSBSZXNpemVRdWFudHVtTWVtb3J5KGJsb2JfaW5mby0+ZGF0YSwKKyAgICAgICAgYmxvYl9pbmZvLT5leHRlbnQrMSxzaXplb2YoKmJsb2JfaW5mby0+ZGF0YSkpOworICAgICAgKHZvaWQpIFN5bmNCbG9iKGltYWdlKTsKKyAgICAgIGlmIChibG9iX2luZm8tPmRhdGEgPT0gTlVMTCkKKyAgICAgICAgeworICAgICAgICAgICh2b2lkKSBEZXRhY2hCbG9iKGJsb2JfaW5mbyk7CisgICAgICAgICAgcmV0dXJuKC0xKTsKKyAgICAgICAgfQogICAgICAgYnJlYWs7CiAgICAgfQogICAgIGNhc2UgQ3VzdG9tU3RyZWFtOgpkaWZmIC0tZ2l0IGEvTWFnaWNrQ29yZS9jYWNoZS5jIGIvTWFnaWNrQ29yZS9jYWNoZS5jCmluZGV4IDQzODUwN2UyZS4uZGFlM2FhOGQ3IDEwMDY0NAotLS0gYS9NYWdpY2tDb3JlL2NhY2hlLmMKKysrIGIvTWFnaWNrQ29yZS9jYWNoZS5jCkBAIC01MzYsNyArNTM2LDcgQEAgc3RhdGljIE1hZ2lja0Jvb2xlYW5UeXBlIENsb25lUGl4ZWxDYWNoZVJlcG9zaXRvcnkoCiAgIENhY2hlSW5mbyAqbWFnaWNrX3Jlc3RyaWN0IGNsb25lX2luZm8sQ2FjaGVJbmZvICptYWdpY2tfcmVzdHJpY3QgY2FjaGVfaW5mbywKICAgRXhjZXB0aW9uSW5mbyAqZXhjZXB0aW9uKQogewotI2RlZmluZSBNYXhDYWNoZVRocmVhZHMgICgoc2l6ZV90KSBHZXRNYWdpY2tSZXNvdXJjZUxpbWl0KFRocmVhZFJlc291cmNlKSkKKyNkZWZpbmUgTWF4Q2FjaGVUaHJlYWRzICBHZXRNYWdpY2tSZXNvdXJjZUxpbWl0KFRocmVhZFJlc291cmNlKQogI2RlZmluZSBjYWNoZV9udW1iZXJfdGhyZWFkcyhzb3VyY2UsZGVzdGluYXRpb24sY2h1bmssbXVsdGl0aHJlYWRlZCkgXAogICBudW1fdGhyZWFkcygobXVsdGl0aHJlYWRlZCkgPT0gMCA/IDEgOiBcCiAgICAgKCgoc291cmNlKS0+dHlwZSAhPSBNZW1vcnlDYWNoZSkgJiYgXApAQCAtMzQzMiw3ICszNDMyLDYgQEAgc3RhdGljIE1hZ2lja0Jvb2xlYW5UeXBlIE9wZW5QaXhlbENhY2hlKEltYWdlICppbWFnZSxjb25zdCBNYXBNb2RlIG1vZGUsCiAgICAgbWVzc2FnZVtNYWdpY2tQYXRoRXh0ZW50XTsKIAogICBjb25zdCBjaGFyCi0gICAgKmhvc3RzLAogICAgICp0eXBlOwogCiAgIE1hZ2lja0Jvb2xlYW5UeXBlCkBAIC0zNTIzLDEyICszNTIyLDExIEBAIHN0YXRpYyBNYWdpY2tCb29sZWFuVHlwZSBPcGVuUGl4ZWxDYWNoZShJbWFnZSAqaW1hZ2UsY29uc3QgTWFwTW9kZSBtb2RlLAogICAgIHN0YXR1cz1NYWdpY2tGYWxzZTsKICAgbGVuZ3RoPW51bWJlcl9waXhlbHMqKGNhY2hlX2luZm8tPm51bWJlcl9jaGFubmVscypzaXplb2YoUXVhbnR1bSkrCiAgICAgY2FjaGVfaW5mby0+bWV0YWNvbnRlbnRfZXh0ZW50KTsKLSAgaWYgKChzdGF0dXMgIT0gTWFnaWNrRmFsc2UpICYmCi0gICAgICAobGVuZ3RoID09IChNYWdpY2tTaXplVHlwZSkgKChzaXplX3QpIGxlbmd0aCkpICYmCi0gICAgICAoKGNhY2hlX2luZm8tPnR5cGUgPT0gVW5kZWZpbmVkQ2FjaGUpIHx8IChjYWNoZV9pbmZvLT50eXBlID09IE1lbW9yeUNhY2hlKSkpCisgIGlmICgoc3RhdHVzICE9IE1hZ2lja0ZhbHNlKSAmJiAobGVuZ3RoID09IChNYWdpY2tTaXplVHlwZSkgKChzaXplX3QpIGxlbmd0aCkpKQogICAgIHsKICAgICAgIHN0YXR1cz1BY3F1aXJlTWFnaWNrUmVzb3VyY2UoTWVtb3J5UmVzb3VyY2UsY2FjaGVfaW5mby0+bGVuZ3RoKTsKLSAgICAgIGlmIChzdGF0dXMgIT0gTWFnaWNrRmFsc2UpCisgICAgICBpZiAoKChjYWNoZV9pbmZvLT50eXBlID09IFVuZGVmaW5lZENhY2hlKSAmJiAoc3RhdHVzICE9IE1hZ2lja0ZhbHNlKSkgfHwKKyAgICAgICAgICAoY2FjaGVfaW5mby0+dHlwZSA9PSBNZW1vcnlDYWNoZSkpCiAgICAgICAgIHsKICAgICAgICAgICBzdGF0dXM9TWFnaWNrVHJ1ZTsKICAgICAgICAgICBpZiAoY2FjaGVfYW5vbnltb3VzX21lbW9yeSA8PSAwKQpAQCAtMzU4MCwxOCArMzU3OCwxOSBAQCBzdGF0aWMgTWFnaWNrQm9vbGVhblR5cGUgT3BlblBpeGVsQ2FjaGUoSW1hZ2UgKmltYWdlLGNvbnN0IE1hcE1vZGUgbW9kZSwKICAgICAgICAgICAgICAgcmV0dXJuKHN0YXR1cyA9PSAwID8gTWFnaWNrRmFsc2UgOiBNYWdpY2tUcnVlKTsKICAgICAgICAgICAgIH0KICAgICAgICAgfQorICAgICAgUmVsaW5xdWlzaE1hZ2lja1Jlc291cmNlKE1lbW9yeVJlc291cmNlLGNhY2hlX2luZm8tPmxlbmd0aCk7CiAgICAgfQorICAvKgorICAgIENyZWF0ZSBwaXhlbCBjYWNoZSBvbiBkaXNrLgorICAqLwogICBzdGF0dXM9QWNxdWlyZU1hZ2lja1Jlc291cmNlKERpc2tSZXNvdXJjZSxjYWNoZV9pbmZvLT5sZW5ndGgpOwotICBob3N0cz0oY29uc3QgY2hhciAqKSBHZXRJbWFnZVJlZ2lzdHJ5KFN0cmluZ1JlZ2lzdHJ5VHlwZSwiY2FjaGU6aG9zdHMiLAotICAgIGV4Y2VwdGlvbik7Ci0gIGlmICgoc3RhdHVzID09IE1hZ2lja0ZhbHNlKSAmJiAoaG9zdHMgIT0gKGNvbnN0IGNoYXIgKikgTlVMTCkpCisgIGlmICgoc3RhdHVzID09IE1hZ2lja0ZhbHNlKSB8fCAoY2FjaGVfaW5mby0+dHlwZSA9PSBEaXN0cmlidXRlZENhY2hlKSkKICAgICB7CiAgICAgICBEaXN0cmlidXRlQ2FjaGVJbmZvCiAgICAgICAgICpzZXJ2ZXJfaW5mbzsKIAotICAgICAgLyoKLSAgICAgICAgRGlzdHJpYnV0ZSB0aGUgcGl4ZWwgY2FjaGUgdG8gYSByZW1vdGUgc2VydmVyLgotICAgICAgKi8KKyAgICAgIGlmIChjYWNoZV9pbmZvLT50eXBlID09IERpc3RyaWJ1dGVkQ2FjaGUpCisgICAgICAgIFJlbGlucXVpc2hNYWdpY2tSZXNvdXJjZShEaXNrUmVzb3VyY2UsY2FjaGVfaW5mby0+bGVuZ3RoKTsKICAgICAgIHNlcnZlcl9pbmZvPUFjcXVpcmVEaXN0cmlidXRlQ2FjaGVJbmZvKGV4Y2VwdGlvbik7CiAgICAgICBpZiAoc2VydmVyX2luZm8gIT0gKERpc3RyaWJ1dGVDYWNoZUluZm8gKikgTlVMTCkKICAgICAgICAgewpAQCAtMzY0MSwxNyArMzY0MCw3IEBAIHN0YXRpYyBNYWdpY2tCb29sZWFuVHlwZSBPcGVuUGl4ZWxDYWNoZShJbWFnZSAqaW1hZ2UsY29uc3QgTWFwTW9kZSBtb2RlLAogICAgICAgICAgICAgICByZXR1cm4oc3RhdHVzID09IDAgPyBNYWdpY2tGYWxzZSA6IE1hZ2lja1RydWUpOwogICAgICAgICAgICAgfQogICAgICAgICB9Ci0gICAgICBjYWNoZV9pbmZvLT50eXBlPVVuZGVmaW5lZENhY2hlOwotICAgICAgKHZvaWQpIFRocm93TWFnaWNrRXhjZXB0aW9uKGV4Y2VwdGlvbixHZXRNYWdpY2tNb2R1bGUoKSxDYWNoZUVycm9yLAotICAgICAgICAiQ2FjaGVSZXNvdXJjZXNFeGhhdXN0ZWQiLCJgJXMnIixpbWFnZS0+ZmlsZW5hbWUpOwotICAgICAgcmV0dXJuKE1hZ2lja0ZhbHNlKTsKLSAgICB9Ci0gIC8qCi0gICAgQ3JlYXRlIHBpeGVsIGNhY2hlIG9uIGRpc2suCi0gICovCi0gIGlmIChzdGF0dXMgPT0gTWFnaWNrRmFsc2UpCi0gICAgewotICAgICAgY2FjaGVfaW5mby0+dHlwZT1VbmRlZmluZWRDYWNoZTsKKyAgICAgIFJlbGlucXVpc2hNYWdpY2tSZXNvdXJjZShEaXNrUmVzb3VyY2UsY2FjaGVfaW5mby0+bGVuZ3RoKTsKICAgICAgICh2b2lkKSBUaHJvd01hZ2lja0V4Y2VwdGlvbihleGNlcHRpb24sR2V0TWFnaWNrTW9kdWxlKCksQ2FjaGVFcnJvciwKICAgICAgICAgIkNhY2hlUmVzb3VyY2VzRXhoYXVzdGVkIiwiYCVzJyIsaW1hZ2UtPmZpbGVuYW1lKTsKICAgICAgIHJldHVybihNYWdpY2tGYWxzZSk7CkBAIC0zNzM3LDYgKzM3MjYsNyBAQCBzdGF0aWMgTWFnaWNrQm9vbGVhblR5cGUgT3BlblBpeGVsQ2FjaGUoSW1hZ2UgKmltYWdlLGNvbnN0IE1hcE1vZGUgbW9kZSwKICAgICAgICAgICAgICAgcmV0dXJuKHN0YXR1cyA9PSAwID8gTWFnaWNrRmFsc2UgOiBNYWdpY2tUcnVlKTsKICAgICAgICAgICAgIH0KICAgICAgICAgfQorICAgICAgUmVsaW5xdWlzaE1hZ2lja1Jlc291cmNlKE1hcFJlc291cmNlLGNhY2hlX2luZm8tPmxlbmd0aCk7CiAgICAgfQogICBzdGF0dXM9TWFnaWNrVHJ1ZTsKICAgaWYgKChzb3VyY2VfaW5mby5zdG9yYWdlX2NsYXNzICE9IFVuZGVmaW5lZENsYXNzKSAmJiAobW9kZSAhPSBSZWFkTW9kZSkpCkBAIC0zODQ0LDEzICszODM0LDYgQEAgTWFnaWNrRXhwb3J0IE1hZ2lja0Jvb2xlYW5UeXBlIFBlcnNpc3RQaXhlbENhY2hlKEltYWdlICppbWFnZSwKICAgLyoKICAgICBDbG9uZSBwZXJzaXN0ZW50IHBpeGVsIGNhY2hlLgogICAqLwotICBzdGF0dXM9QWNxdWlyZU1hZ2lja1Jlc291cmNlKERpc2tSZXNvdXJjZSxjYWNoZV9pbmZvLT5sZW5ndGgpOwotICBpZiAoc3RhdHVzID09IE1hZ2lja0ZhbHNlKQotICAgIHsKLSAgICAgICh2b2lkKSBUaHJvd01hZ2lja0V4Y2VwdGlvbihleGNlcHRpb24sR2V0TWFnaWNrTW9kdWxlKCksQ2FjaGVFcnJvciwKLSAgICAgICAgIkNhY2hlUmVzb3VyY2VzRXhoYXVzdGVkIiwiYCVzJyIsaW1hZ2UtPmZpbGVuYW1lKTsKLSAgICAgIHJldHVybihNYWdpY2tGYWxzZSk7Ci0gICAgfQogICBjbG9uZV9pbmZvPShDYWNoZUluZm8gKikgQ2xvbmVQaXhlbENhY2hlKGNhY2hlX2luZm8pOwogICBjbG9uZV9pbmZvLT50eXBlPURpc2tDYWNoZTsKICAgKHZvaWQpIENvcHlNYWdpY2tTdHJpbmcoY2xvbmVfaW5mby0+Y2FjaGVfZmlsZW5hbWUsZmlsZW5hbWUsTWFnaWNrUGF0aEV4dGVudCk7CmRpZmYgLS1naXQgYS9NYWdpY2tDb3JlL21hdHJpeC5jIGIvTWFnaWNrQ29yZS9tYXRyaXguYwppbmRleCAyZGY2YjU1MGEuLmU4M2JhZWNiMSAxMDA2NDQKLS0tIGEvTWFnaWNrQ29yZS9tYXRyaXguYworKysgYi9NYWdpY2tDb3JlL21hdHJpeC5jCkBAIC0zMzEsMTIgKzMzMSwxMiBAQCBNYWdpY2tFeHBvcnQgZG91YmxlICoqQWNxdWlyZU1hZ2lja01hdHJpeChjb25zdCBzaXplX3QgbnVtYmVyX3Jvd3MsCiAgIHsKICAgICBtYXRyaXhbaV09KGRvdWJsZSAqKSBBY3F1aXJlUXVhbnR1bU1lbW9yeShzaXplLHNpemVvZigqbWF0cml4W2ldKSk7CiAgICAgaWYgKG1hdHJpeFtpXSA9PSAoZG91YmxlICopIE5VTEwpCi0gICAgICB7Ci0gICAgICAgIGZvciAoaj0wOyBqIDwgaTsgaisrKQotICAgICAgICAgIG1hdHJpeFtqXT0oZG91YmxlICopIFJlbGlucXVpc2hNYWdpY2tNZW1vcnkobWF0cml4W2pdKTsKLSAgICAgICAgbWF0cml4PShkb3VibGUgKiopIFJlbGlucXVpc2hNYWdpY2tNZW1vcnkobWF0cml4KTsKLSAgICAgICAgcmV0dXJuKChkb3VibGUgKiopIE5VTEwpOwotICAgICAgfQorICAgIHsKKyAgICAgIGZvciAoaj0wOyBqIDwgaTsgaisrKQorICAgICAgICBtYXRyaXhbal09KGRvdWJsZSAqKSBSZWxpbnF1aXNoTWFnaWNrTWVtb3J5KG1hdHJpeFtqXSk7CisgICAgICBtYXRyaXg9KGRvdWJsZSAqKikgUmVsaW5xdWlzaE1hZ2lja01lbW9yeShtYXRyaXgpOworICAgICAgcmV0dXJuKChkb3VibGUgKiopIE5VTEwpOworICAgIH0KICAgICBmb3IgKGo9MDsgaiA8IChzc2l6ZV90KSBzaXplOyBqKyspCiAgICAgICBtYXRyaXhbaV1bal09MC4wOwogICB9CkBAIC0xMDcxLDcgKzEwNzEsNyBAQCBNYWdpY2tFeHBvcnQgZG91YmxlICoqUmVsaW5xdWlzaE1hZ2lja01hdHJpeChkb3VibGUgKiptYXRyaXgsCiAgIGlmIChtYXRyaXggPT0gKGRvdWJsZSAqKikgTlVMTCApCiAgICAgcmV0dXJuKG1hdHJpeCk7CiAgIGZvciAoaT0wOyBpIDwgKHNzaXplX3QpIG51bWJlcl9yb3dzOyBpKyspCi0gICAgbWF0cml4W2ldPShkb3VibGUgKikgUmVsaW5xdWlzaE1hZ2lja01lbW9yeShtYXRyaXhbaV0pOworICAgICBtYXRyaXhbaV09KGRvdWJsZSAqKSBSZWxpbnF1aXNoTWFnaWNrTWVtb3J5KG1hdHJpeFtpXSk7CiAgIG1hdHJpeD0oZG91YmxlICoqKSBSZWxpbnF1aXNoTWFnaWNrTWVtb3J5KG1hdHJpeCk7CiAgIHJldHVybihtYXRyaXgpOwogfQpkaWZmIC0tZ2l0IGEvTWFnaWNrQ29yZS9vcGVuY2wuYyBiL01hZ2lja0NvcmUvb3BlbmNsLmMKaW5kZXggNjRjNTRmMDI0Li4zMTNkZjE3OTkgMTAwNjQ0Ci0tLSBhL01hZ2lja0NvcmUvb3BlbmNsLmMKKysrIGIvTWFnaWNrQ29yZS9vcGVuY2wuYwpAQCAtMjg5NCw2ICsyODk0LDcgQEAgc3RhdGljIHZvaWQgQ0xfQVBJX0NBTEwgRGVzdHJveU1hZ2lja0NMQ2FjaGVJbmZvQW5kUGl4ZWxzKAogICAgICAgfQogICB9CiAgIHBpeGVscz1pbmZvLT5waXhlbHM7CisgIFJlbGlucXVpc2hNYWdpY2tSZXNvdXJjZShNZW1vcnlSZXNvdXJjZSxpbmZvLT5sZW5ndGgpOwogICBEZXN0cm95TWFnaWNrQ0xDYWNoZUluZm8oaW5mbyk7CiAgICh2b2lkKSBSZWxpbnF1aXNoQWxpZ25lZE1lbW9yeShwaXhlbHMpOwogfQpkaWZmIC0tZ2l0IGEvTWFnaWNrQ29yZS9yZWdpc3RyeS5jIGIvTWFnaWNrQ29yZS9yZWdpc3RyeS5jCmluZGV4IGIwYWQ4NTY2Ni4uMmUxNTlmN2Y4IDEwMDY0NAotLS0gYS9NYWdpY2tDb3JlL3JlZ2lzdHJ5LmMKKysrIGIvTWFnaWNrQ29yZS9yZWdpc3RyeS5jCkBAIC0xOTksNyArMTk5LDExIEBAIE1hZ2lja0V4cG9ydCB2b2lkICpHZXRJbWFnZVJlZ2lzdHJ5KGNvbnN0IFJlZ2lzdHJ5VHlwZSB0eXBlLGNvbnN0IGNoYXIgKmtleSwKICAgICByZXR1cm4oKHZvaWQgKikgTlVMTCk7CiAgIHJlZ2lzdHJ5X2luZm89KFJlZ2lzdHJ5SW5mbyAqKSBHZXRWYWx1ZUZyb21TcGxheVRyZWUocmVnaXN0cnksa2V5KTsKICAgaWYgKHJlZ2lzdHJ5X2luZm8gPT0gKHZvaWQgKikgTlVMTCkKLSAgICByZXR1cm4oKHZvaWQgKikgTlVMTCk7CisgICAgeworICAgICAgKHZvaWQpIFRocm93TWFnaWNrRXhjZXB0aW9uKGV4Y2VwdGlvbixHZXRNYWdpY2tNb2R1bGUoKSxSZWdpc3RyeUVycm9yLAorICAgICAgICAiVW5hYmxlVG9HZXRSZWdpc3RyeUlEIiwiYCVzJyIsa2V5KTsKKyAgICAgIHJldHVybigodm9pZCAqKSBOVUxMKTsKKyAgICB9CiAgIHZhbHVlPSh2b2lkICopIE5VTEw7CiAgIHN3aXRjaCAodHlwZSkKICAgewpkaWZmIC0tZ2l0IGEvTWFnaWNrQ29yZS9yZXNvdXJjZS5jIGIvTWFnaWNrQ29yZS9yZXNvdXJjZS5jCmluZGV4IDk0NTNkMzc1ZC4uYTY1YzVhMzI4IDEwMDY0NAotLS0gYS9NYWdpY2tDb3JlL3Jlc291cmNlLmMKKysrIGIvTWFnaWNrQ29yZS9yZXNvdXJjZS5jCkBAIC0yMTAsNyArMjEwLDcgQEAgTWFnaWNrRXhwb3J0IE1hZ2lja0Jvb2xlYW5UeXBlIEFjcXVpcmVNYWdpY2tSZXNvdXJjZShjb25zdCBSZXNvdXJjZVR5cGUgdHlwZSwKICAgICAgIHJlc291cmNlX2luZm8ubWVtb3J5Kz0oTWFnaWNrT2Zmc2V0VHlwZSkgc2l6ZTsKICAgICAgIGxpbWl0PXJlc291cmNlX2luZm8ubWVtb3J5X2xpbWl0OwogICAgICAgaWYgKChsaW1pdCA9PSBNYWdpY2tSZXNvdXJjZUluZmluaXR5KSB8fAotICAgICAgICAgIChyZXNvdXJjZV9pbmZvLm1lbW9yeSA8IChNYWdpY2tPZmZzZXRUeXBlKSBsaW1pdCkpCisgICAgICAgICAgKChNYWdpY2tTaXplVHlwZSkgcmVzb3VyY2VfaW5mby5tZW1vcnkgPCBsaW1pdCkpCiAgICAgICAgIHN0YXR1cz1NYWdpY2tUcnVlOwogICAgICAgZWxzZQogICAgICAgICByZXNvdXJjZV9pbmZvLm1lbW9yeS09KE1hZ2lja09mZnNldFR5cGUpIHNpemU7CkBAIC0yMzAsNyArMjMwLDcgQEAgTWFnaWNrRXhwb3J0IE1hZ2lja0Jvb2xlYW5UeXBlIEFjcXVpcmVNYWdpY2tSZXNvdXJjZShjb25zdCBSZXNvdXJjZVR5cGUgdHlwZSwKICAgICAgIHJlc291cmNlX2luZm8ubWFwKz0oTWFnaWNrT2Zmc2V0VHlwZSkgc2l6ZTsKICAgICAgIGxpbWl0PXJlc291cmNlX2luZm8ubWFwX2xpbWl0OwogICAgICAgaWYgKChsaW1pdCA9PSBNYWdpY2tSZXNvdXJjZUluZmluaXR5KSB8fAotICAgICAgICAgIChyZXNvdXJjZV9pbmZvLm1hcCA8IChNYWdpY2tPZmZzZXRUeXBlKSBsaW1pdCkpCisgICAgICAgICAgKChNYWdpY2tTaXplVHlwZSkgcmVzb3VyY2VfaW5mby5tYXAgPCBsaW1pdCkpCiAgICAgICAgIHN0YXR1cz1NYWdpY2tUcnVlOwogICAgICAgZWxzZQogICAgICAgICByZXNvdXJjZV9pbmZvLm1hcC09KE1hZ2lja09mZnNldFR5cGUpIHNpemU7CkBAIC0yNTAsNyArMjUwLDcgQEAgTWFnaWNrRXhwb3J0IE1hZ2lja0Jvb2xlYW5UeXBlIEFjcXVpcmVNYWdpY2tSZXNvdXJjZShjb25zdCBSZXNvdXJjZVR5cGUgdHlwZSwKICAgICAgIHJlc291cmNlX2luZm8uZGlzays9KE1hZ2lja09mZnNldFR5cGUpIHNpemU7CiAgICAgICBsaW1pdD1yZXNvdXJjZV9pbmZvLmRpc2tfbGltaXQ7CiAgICAgICBpZiAoKGxpbWl0ID09IE1hZ2lja1Jlc291cmNlSW5maW5pdHkpIHx8Ci0gICAgICAgICAgKHJlc291cmNlX2luZm8uZGlzayA8IChNYWdpY2tPZmZzZXRUeXBlKSBsaW1pdCkpCisgICAgICAgICAgKChNYWdpY2tTaXplVHlwZSkgcmVzb3VyY2VfaW5mby5kaXNrIDwgbGltaXQpKQogICAgICAgICBzdGF0dXM9TWFnaWNrVHJ1ZTsKICAgICAgIGVsc2UKICAgICAgICAgcmVzb3VyY2VfaW5mby5kaXNrLT0oTWFnaWNrT2Zmc2V0VHlwZSkgc2l6ZTsKQEAgLTI3MCw3ICsyNzAsNyBAQCBNYWdpY2tFeHBvcnQgTWFnaWNrQm9vbGVhblR5cGUgQWNxdWlyZU1hZ2lja1Jlc291cmNlKGNvbnN0IFJlc291cmNlVHlwZSB0eXBlLAogICAgICAgcmVzb3VyY2VfaW5mby5maWxlKz0oTWFnaWNrT2Zmc2V0VHlwZSkgc2l6ZTsKICAgICAgIGxpbWl0PXJlc291cmNlX2luZm8uZmlsZV9saW1pdDsKICAgICAgIGlmICgobGltaXQgPT0gTWFnaWNrUmVzb3VyY2VJbmZpbml0eSkgfHwKLSAgICAgICAgICAocmVzb3VyY2VfaW5mby5maWxlIDwgKE1hZ2lja09mZnNldFR5cGUpIGxpbWl0KSkKKyAgICAgICAgICAoKE1hZ2lja1NpemVUeXBlKSByZXNvdXJjZV9pbmZvLmZpbGUgPCBsaW1pdCkpCiAgICAgICAgIHN0YXR1cz1NYWdpY2tUcnVlOwogICAgICAgZWxzZQogICAgICAgICByZXNvdXJjZV9pbmZvLmZpbGUtPShNYWdpY2tPZmZzZXRUeXBlKSBzaXplOwpAQCAtMzA3LDcgKzMwNyw3IEBAIE1hZ2lja0V4cG9ydCBNYWdpY2tCb29sZWFuVHlwZSBBY3F1aXJlTWFnaWNrUmVzb3VyY2UoY29uc3QgUmVzb3VyY2VUeXBlIHR5cGUsCiAgICAgewogICAgICAgbGltaXQ9cmVzb3VyY2VfaW5mby50aHJlYWRfbGltaXQ7CiAgICAgICBpZiAoKGxpbWl0ID09IE1hZ2lja1Jlc291cmNlSW5maW5pdHkpIHx8Ci0gICAgICAgICAgKHJlc291cmNlX2luZm8udGhyZWFkIDwgKE1hZ2lja09mZnNldFR5cGUpIGxpbWl0KSkKKyAgICAgICAgICAoKE1hZ2lja1NpemVUeXBlKSByZXNvdXJjZV9p\n[... Observation truncated due to length ...]\nc2l6ZV90IGNoYW5uZWxzLAogICAgIH0KICAgaWYgKFJlYWRCbG9iKGltYWdlLGNvbXBhY3Rfc2l6ZSxjb21wYWN0X3BpeGVscykgIT0gKHNzaXplX3QpIGNvbXBhY3Rfc2l6ZSkKICAgICB7Ci0gICAgICBwaXhlbHM9KHVuc2lnbmVkIGNoYXIgKikgUmVsaW5xdWlzaE1hZ2lja01lbW9yeShwaXhlbHMpOwogICAgICAgY29tcGFjdF9waXhlbHM9KHVuc2lnbmVkIGNoYXIgKikgUmVsaW5xdWlzaE1hZ2lja01lbW9yeShjb21wYWN0X3BpeGVscyk7CiAgICAgICBUaHJvd0JpbmFyeUV4Y2VwdGlvbihDb3JydXB0SW1hZ2VFcnJvciwiVW5leHBlY3RlZEVuZE9mRmlsZSIsCiAgICAgICAgIGltYWdlLT5maWxlbmFtZSk7CkBAIC0xMjY0LDYgKzEyNjMsOCBAQCBzdGF0aWMgTWFnaWNrQm9vbGVhblR5cGUgUmVhZFBTRENoYW5uZWxaaXAoSW1hZ2UgKmltYWdlLGNvbnN0IHNpemVfdCBjaGFubmVscywKICAgICAgIHsKICAgICAgICAgcmV0PWluZmxhdGUoJnN0cmVhbSxaX1NZTkNfRkxVU0gpOwogICAgICAgICBpZiAoKHJldCAhPSBaX09LKSAmJiAocmV0ICE9IFpfU1RSRUFNX0VORCkpCisgICAgICAgICAgYnJlYWs7CisgICAgICAgIGlmIChyZXQgPT0gWl9TVFJFQU1fRU5EKQogICAgICAgICAgIHsKICAgICAgICAgICAgICh2b2lkKSBpbmZsYXRlRW5kKCZzdHJlYW0pOwogICAgICAgICAgICAgY29tcGFjdF9waXhlbHM9KHVuc2lnbmVkIGNoYXIgKikgUmVsaW5xdWlzaE1hZ2lja01lbW9yeSgKQEAgLTEyNzEsMzMgKzEyNzIsMzEgQEAgc3RhdGljIE1hZ2lja0Jvb2xlYW5UeXBlIFJlYWRQU0RDaGFubmVsWmlwKEltYWdlICppbWFnZSxjb25zdCBzaXplX3QgY2hhbm5lbHMsCiAgICAgICAgICAgICBwaXhlbHM9KHVuc2lnbmVkIGNoYXIgKikgUmVsaW5xdWlzaE1hZ2lja01lbW9yeShwaXhlbHMpOwogICAgICAgICAgICAgcmV0dXJuKE1hZ2lja0ZhbHNlKTsKICAgICAgICAgICB9Ci0gICAgICAgIGlmIChyZXQgPT0gWl9TVFJFQU1fRU5EKQotICAgICAgICAgIGJyZWFrOwogICAgICAgfQogICAgICAgKHZvaWQpIGluZmxhdGVFbmQoJnN0cmVhbSk7CiAgICAgfQogCiAgIGlmIChjb21wcmVzc2lvbiA9PSBaaXBXaXRoUHJlZGljdGlvbikKLSAgICB7Ci0gICAgICBwPXBpeGVsczsKLSAgICAgIHdoaWxlIChjb3VudCA+IDApCi0gICAgICB7Ci0gICAgICAgIGxlbmd0aD1pbWFnZS0+Y29sdW1uczsKLSAgICAgICAgd2hpbGUgKC0tbGVuZ3RoKQotICAgICAgICB7Ci0gICAgICAgICAgaWYgKHBhY2tldF9zaXplID09IDIpCi0gICAgICAgICAgICB7Ci0gICAgICAgICAgICAgIHBbMl0rPXBbMF0rKChwWzFdK3BbM10pID4+IDgpOwotICAgICAgICAgICAgICBwWzNdKz1wWzFdOwotICAgICAgICAgICAgfQotICAgICAgICAgIGVsc2UKLSAgICAgICAgICAgICoocCsxKSs9KnA7Ci0gICAgICAgICAgcCs9cGFja2V0X3NpemU7Ci0gICAgICAgIH0KLSAgICAgICAgcCs9cGFja2V0X3NpemU7Ci0gICAgICAgIGNvdW50LT1yb3dfc2l6ZTsKLSAgICAgIH0KLSAgICB9CisgIHsKKyAgICAgcD1waXhlbHM7CisgICAgIHdoaWxlIChjb3VudCA+IDApCisgICAgIHsKKyAgICAgICBsZW5ndGg9aW1hZ2UtPmNvbHVtbnM7CisgICAgICAgd2hpbGUgKC0tbGVuZ3RoKQorICAgICAgIHsKKyAgICAgICAgIGlmIChwYWNrZXRfc2l6ZSA9PSAyKQorICAgICAgICAgICB7CisgICAgICAgICAgICAgcFsyXSs9cFswXSsoKHBbMV0rcFszXSkgPj4gOCk7CisgICAgICAgICAgICAgcFszXSs9cFsxXTsKKyAgICAgICAgICAgfQorICAgICAgICAgZWxzZQorICAgICAgICAgICoocCsxKSs9KnA7CisgICAgICAgICBwKz1wYWNrZXRfc2l6ZTsKKyAgICAgICB9CisgICAgICAgcCs9cGFja2V0X3NpemU7CisgICAgICAgY291bnQtPXJvd19zaXplOworICAgICB9CisgIH0KIAogICBzdGF0dXM9TWFnaWNrVHJ1ZTsKICAgcD1waXhlbHM7CmRpZmYgLS1naXQgYS9jb2RlcnMvc3ZnLmMgYi9jb2RlcnMvc3ZnLmMKaW5kZXggYzNlNzM0MTVjLi4zMTkwYjVjZDUgMTAwNjQ0Ci0tLSBhL2NvZGVycy9zdmcuYworKysgYi9jb2RlcnMvc3ZnLmMKQEAgLTMwODEsMTEgKzMwODEsOCBAQCBzdGF0aWMgSW1hZ2UgKlJlYWRTVkdJbWFnZShjb25zdCBJbWFnZUluZm8gKmltYWdlX2luZm8sRXhjZXB0aW9uSW5mbyAqZXhjZXB0aW9uKQogICAgICAgICAgICAgY2Fpcm9fc3VyZmFjZT1jYWlyb19pbWFnZV9zdXJmYWNlX2NyZWF0ZV9mb3JfZGF0YShwaXhlbHMsCiAgICAgICAgICAgICAgIENBSVJPX0ZPUk1BVF9BUkdCMzIsKGludCkgaW1hZ2UtPmNvbHVtbnMsKGludCkgaW1hZ2UtPnJvd3MsKGludCkKICAgICAgICAgICAgICAgc3RyaWRlKTsKLSAgICAgICAgICAgIGlmICgoY2Fpcm9fc3VyZmFjZSA9PSAoY2Fpcm9fc3VyZmFjZV90ICopIE5VTEwpIHx8Ci0gICAgICAgICAgICAgICAgKGNhaXJvX3N1cmZhY2Vfc3RhdHVzKGNhaXJvX3N1cmZhY2UpICE9IENBSVJPX1NUQVRVU19TVUNDRVNTKSkKKyAgICAgICAgICAgIGlmIChjYWlyb19zdXJmYWNlID09IChjYWlyb19zdXJmYWNlX3QgKikgTlVMTCkKICAgICAgICAgICAgICAgewotICAgICAgICAgICAgICAgIGlmIChjYWlyb19zdXJmYWNlICE9IChjYWlyb19zdXJmYWNlX3QgKikgTlVMTCkKLSAgICAgICAgICAgICAgICAgIGNhaXJvX3N1cmZhY2VfZGVzdHJveShjYWlyb19zdXJmYWNlKTsKICAgICAgICAgICAgICAgICBwaXhlbF9pbmZvPVJlbGlucXVpc2hWaXJ0dWFsTWVtb3J5KHBpeGVsX2luZm8pOwogICAgICAgICAgICAgICAgIGdfb2JqZWN0X3VucmVmKHN2Z19oYW5kbGUpOwogICAgICAgICAgICAgICAgIFRocm93UmVhZGVyRXhjZXB0aW9uKFJlc291cmNlTGltaXRFcnJvciwKZGlmZiAtLWdpdCBhL2NvZGVycy93cGcuYyBiL2NvZGVycy93cGcuYwppbmRleCA4MjIzMjI5ZTUuLmVhZDNmNDYwZCAxMDA2NDQKLS0tIGEvY29kZXJzL3dwZy5jCisrKyBiL2NvZGVycy93cGcuYwpAQCAtMzU3LDExICszNTcsMTEgQEAgc3RhdGljIE1hZ2lja0Jvb2xlYW5UeXBlIEluc2VydFJvdyhJbWFnZSAqaW1hZ2UsdW5zaWduZWQgY2hhciAqcCxzc2l6ZV90IHksCiAgICAgICAgICAgfQogICAgICAgICBicmVhazsKICAgICAgIH0KLQorIAogICAgIGNhc2UgNDogIC8qIENvbnZlcnQgUHNldWRvQ29sb3Igc2NhbmxpbmUuICovCiAgICAgICB7CiAgICAgICAgIGZvciAoeD0wOyB4IDwgKChzc2l6ZV90KSBpbWFnZS0+Y29sdW1ucy0xKTsgeCs9MikKLSAgICAgICAgICB7CisgICAgICAgICAgeyAKICAgICAgICAgICAgIGluZGV4PUNvbnN0cmFpbkNvbG9ybWFwSW5kZXgoaW1hZ2UsKCpwID4+IDQpICYgMHgwZixleGNlcHRpb24pOwogICAgICAgICAgICAgU2V0UGl4ZWxJbmRleChpbWFnZSxpbmRleCxxKTsKICAgICAgICAgICAgIFNldFBpeGVsVmlhUGl4ZWxJbmZvKGltYWdlLGltYWdlLT5jb2xvcm1hcCsoc3NpemVfdCkgaW5kZXgscSk7CkBAIC0zOTQsNyArMzk0LDcgQEAgc3RhdGljIE1hZ2lja0Jvb2xlYW5UeXBlIEluc2VydFJvdyhJbWFnZSAqaW1hZ2UsdW5zaWduZWQgY2hhciAqcCxzc2l6ZV90IHksCiAgICAgICAgICAgfQogICAgICAgfQogICAgICAgYnJlYWs7Ci0KKyAgICAgCiAgICAgY2FzZSAyNDogICAgIC8qICBDb252ZXJ0IERpcmVjdENvbG9yIHNjYW5saW5lLiAgKi8KICAgICAgIGZvciAoeD0wOyB4IDwgKHNzaXplX3QpIGltYWdlLT5jb2x1bW5zOyB4KyspCiAgICAgICAgIHsKQEAgLTYwNCw3ICs2MDQsNyBAQCBzdGF0aWMgaW50IFVucGFja1dQRzJSYXN0ZXIoSW1hZ2UgKmltYWdlLGludCBicHAsRXhjZXB0aW9uSW5mbyAqZXhjZXB0aW9uKQogICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgZm9yKGk9MDsgaTw9IFJ1bkNvdW50O2krKykKICAgICAgICAgICAgIGZvcihiYnVmPTA7IGJidWYgPCBTYW1wbGVTaXplOyBiYnVmKyspCi0gICAgICAgICAgICAgIEluc2VydEJ5dGU2KFNhbXBsZUJ1ZmZlcltiYnVmXSk7CisgICAgICAgICAgICAgIEluc2VydEJ5dGU2KFNhbXBsZUJ1ZmZlcltiYnVmXSk7ICAgICAgICAgIAogICAgICAgICAgIGJyZWFrOwogICAgICAgICBjYXNlIDB4RkU6CiAgICAgICAgICAgUnVuQ291bnQ9UmVhZEJsb2JCeXRlKGltYWdlKTsgIC8qIFJTVCAqLwpAQCAtNjQwLDcgKzY0MCw3IEBAIHN0YXRpYyBpbnQgVW5wYWNrV1BHMlJhc3RlcihJbWFnZSAqaW1hZ2UsaW50IGJwcCxFeGNlcHRpb25JbmZvICpleGNlcHRpb24pCiAgICAgICAgICAgUnVuQ291bnQ9YmJ1ZiAmIDB4N0Y7CiAKICAgICAgICAgICBpZihiYnVmICYgMHg4MCkgICAgIC8qIFJFUCAqLwotICAgICAgICAgICAgeworICAgICAgICAgICAgeyAgCiAgICAgICAgICAgICAgIGZvcihpPTA7IGkgPCBTYW1wbGVTaXplOyBpKyspCiAgICAgICAgICAgICAgICAgU2FtcGxlQnVmZmVyW2ldPVJlYWRCbG9iQnl0ZShpbWFnZSk7CiAgICAgICAgICAgICAgIGZvcihpPTA7aTw9UnVuQ291bnQ7aSsrKQpAQCAtNzMzLDcgKzczMyw3IEBAIHN0YXRpYyBJbWFnZSAqRXh0cmFjdFBvc3RzY3JpcHQoSW1hZ2UgKmltYWdlLGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKICAgICBwb3N0c2NyaXB0X2ZpbGVbTWFnaWNrUGF0aEV4dGVudF07CiAKICAgY29uc3QgTWFnaWNJbmZvCi0gICAgKm1hZ2ljX2luZm87CisgICAgKm1hZ2ljX2luZm87ICAgIAogCiAgIEZJTEUKICAgICAqcHNfZmlsZTsKQEAgLTc0MywxMyArNzQzLDEzIEBAIHN0YXRpYyBJbWFnZSAqRXh0cmFjdFBvc3RzY3JpcHQoSW1hZ2UgKmltYWdlLGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKIAogICBJbWFnZUluZm8KICAgICAqY2xvbmVfaW5mbzsKLQorICAgIAogICBJbWFnZQogICAgICppbWFnZTI7Ci0KKyAgICAKICAgdW5zaWduZWQgY2hhcgotICAgIG1hZ2lja1syKk1hZ2lja1BhdGhFeHRlbnRdOwotCisgICAgbWFnaWNrWzIqTWFnaWNrUGF0aEV4dGVudF07ICAgIAorICAgIAogCiAgIGlmICgoY2xvbmVfaW5mbz1DbG9uZUltYWdlSW5mbyhpbWFnZV9pbmZvKSkgPT0gTlVMTCkKICAgICByZXR1cm4oaW1hZ2UpOwpAQCAtNzY1LDcgKzc2NSw3IEBAIHN0YXRpYyBJbWFnZSAqRXh0cmFjdFBvc3RzY3JpcHQoSW1hZ2UgKmltYWdlLGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKICAgLyogQ29weSBwb3N0c2NyaXB0IHRvIHRlbXBvcmFyeSBmaWxlICovCiAgICh2b2lkKSBTZWVrQmxvYihpbWFnZSxQU19PZmZzZXQsU0VFS19TRVQpOwogICAodm9pZCkgUmVhZEJsb2IoaW1hZ2UsIDIqTWFnaWNrUGF0aEV4dGVudCwgbWFnaWNrKTsKLQorICAKICAgKHZvaWQpIFNlZWtCbG9iKGltYWdlLFBTX09mZnNldCxTRUVLX1NFVCk7CiAgIHdoaWxlIChQU19TaXplLS0gPiAwKQogICB7CkBAIC03NzUsMTYgKzc3NSwxNiBAQCBzdGF0aWMgSW1hZ2UgKkV4dHJhY3RQb3N0c2NyaXB0KEltYWdlICppbWFnZSxjb25zdCBJbWFnZUluZm8gKmltYWdlX2luZm8sCiAgICAgKHZvaWQpIGZwdXRjKGMscHNfZmlsZSk7CiAgIH0KICAgKHZvaWQpIGZjbG9zZShwc19maWxlKTsKLQorICAKICAgICAvKiBEZXRlY3QgZmlsZSBmb3JtYXQgLSBDaGVjayBtYWdpYy5tZ2sgY29uZmlndXJhdGlvbiBmaWxlLiAqLwogICBtYWdpY19pbmZvPUdldE1hZ2ljSW5mbyhtYWdpY2ssMipNYWdpY2tQYXRoRXh0ZW50LGV4Y2VwdGlvbik7CiAgIGlmKG1hZ2ljX2luZm8gPT0gKGNvbnN0IE1hZ2ljSW5mbyAqKSBOVUxMKSBnb3RvIEZJTklTSF9VTkw7CiAgIC8qICAgICBwcmludGYoIkRldGVjdGVkOiVzICBcbiIsbWFnaWNfaW5mby0+bmFtZSk7ICovCi0gIGlmKGV4Y2VwdGlvbi0+c2V2ZXJpdHkgIT0gVW5kZWZpbmVkRXhjZXB0aW9uKSBnb3RvIEZJTklTSF9VTkw7CisgIGlmKGV4Y2VwdGlvbi0+c2V2ZXJpdHkgIT0gVW5kZWZpbmVkRXhjZXB0aW9uKSBnb3RvIEZJTklTSF9VTkw7ICAgICAKICAgaWYobWFnaWNfaW5mby0+bmFtZSA9PSAoY2hhciAqKSBOVUxMKSBnb3RvIEZJTklTSF9VTkw7Ci0KKyAgICAKICAgKHZvaWQpIHN0cm5jcHkoY2xvbmVfaW5mby0+bWFnaWNrLG1hZ2ljX2luZm8tPm5hbWUsTWFnaWNrUGF0aEV4dGVudC0xKTsKLQorICAKICAgICAvKiBSZWFkIG5lc3RlZCBpbWFnZSAqLwogICAvKkZvcm1hdFN0cmluZyhjbG9uZV9pbmZvLT5maWxlbmFtZSwiJXM6JXMiLG1hZ2ljX2luZm8tPm5hbWUscG9zdHNjcmlwdF9maWxlKTsqLwogICBGb3JtYXRMb2NhbGVTdHJpbmcoY2xvbmVfaW5mby0+ZmlsZW5hbWUsTWFnaWNrUGF0aEV4dGVudCwiJXMiLHBvc3RzY3JpcHRfZmlsZSk7CkBAIC04MDksNyArODA5LDcgQEAgc3RhdGljIEltYWdlICpFeHRyYWN0UG9zdHNjcmlwdChJbWFnZSAqaW1hZ2UsY29uc3QgSW1hZ2VJbmZvICppbWFnZV9pbmZvLAogCiAgIEFwcGVuZEltYWdlVG9MaXN0KCZpbWFnZSxpbWFnZTIpOwogCi0gRklOSVNIX1VOTDoKKyBGSU5JU0hfVU5MOiAgICAKICAgKHZvaWQpIFJlbGlucXVpc2hVbmlxdWVGaWxlUmVzb3VyY2UocG9zdHNjcmlwdF9maWxlKTsKICBGSU5JU0g6CiAgIERlc3Ryb3lJbWFnZUluZm8oY2xvbmVfaW5mbyk7CkBAIC05MjQsNyArOTI0LDcgQEAgc3RhdGljIEltYWdlICpSZWFkV1BHSW1hZ2UoY29uc3QgSW1hZ2VJbmZvICppbWFnZV9pbmZvLAogICAgIHNpemVfdCBQU191bmtub3duMTsKICAgICB1bnNpZ25lZCBpbnQgUFNfdW5rbm93bjI7CiAgICAgdW5zaWduZWQgaW50IFBTX3Vua25vd24zOwotICB9IFdQR1BTbDFSZWNvcmQ7CisgIH0gV1BHUFNsMVJlY29yZDsgIAogICAqLwogCiAgIEltYWdlCkBAIC0xMDc3LDEzICsxMDc3LDEzIEBAIHN0YXRpYyBJbWFnZSAqUmVhZFdQR0ltYWdlKGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKICAgICAgICAgICAgICAgICAgICAgUmVhZEJsb2JCeXRlKGltYWdlKSk7CiAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICBicmVhazsKLQorICAgICAKICAgICAgICAgICAgIGNhc2UgMHgxMTogIC8qIFN0YXJ0IFBTIGwxICovCiAgICAgICAgICAgICAgIGlmKFJlYy5SZWNvcmRMZW5ndGggPiA4KQogICAgICAgICAgICAgICAgIGltYWdlPUV4dHJhY3RQb3N0c2NyaXB0KGltYWdlLGltYWdlX2luZm8sCiAgICAgICAgICAgICAgICAgICBUZWxsQmxvYihpbWFnZSkrOCwgICAvKiBza2lwIFBTIGhlYWRlciBpbiB0aGUgd3BnICovCiAgICAgICAgICAgICAgICAgICAoc3NpemVfdCkgUmVjLlJlY29yZExlbmd0aC04LGV4Y2VwdGlvbik7Ci0gICAgICAgICAgICAgIGJyZWFrOworICAgICAgICAgICAgICBicmVhazsgICAgIAogCiAgICAgICAgICAgICBjYXNlIDB4MTQ6ICAvKiBiaXRtYXAgdHlwZSAyICovCiAgICAgICAgICAgICAgIEJpdG1hcEhlYWRlcjIuUm90QW5nbGU9UmVhZEJsb2JMU0JTaG9ydChpbWFnZSk7CkBAIC0xMTE1LDExICsxMTE1LDExIEBAIHN0YXRpYyBJbWFnZSAqUmVhZFdQR0ltYWdlKGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKICAgICAgICAgICAgICAgaW1hZ2UtPnJvd3M9Qml0bWFwSGVhZGVyMi5IZWlnaHQ7CiAgICAgICAgICAgICAgIGJwcD1CaXRtYXBIZWFkZXIyLkRlcHRoOwogCi0gICAgICAgICAgICBVbnBhY2tSYXN0ZXI6CisgICAgICAgICAgICBVbnBhY2tSYXN0ZXI6ICAgICAgCiAgICAgICAgICAgICAgIHN0YXR1cz1TZXRJbWFnZUV4dGVudChpbWFnZSxpbWFnZS0+Y29sdW1ucyxpbWFnZS0+cm93cyxleGNlcHRpb24pOwogICAgICAgICAgICAgICBpZiAoc3RhdHVzID09IE1hZ2lja0ZhbHNlKQogICAgICAgICAgICAgICAgIGJyZWFrOwotICAgICAgICAgICAgICBpZiAoKGltYWdlLT5zdG9yYWdlX2NsYXNzICE9IFBzZXVkb0NsYXNzKSAmJiAoYnBwIDwgMjQpKQorICAgICAgICAgICAgICBpZiAoKGltYWdlLT5zdG9yYWdlX2NsYXNzICE9IFBzZXVkb0NsYXNzKSAmJiAoYnBwICE9IDI0KSkKICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICBpbWFnZS0+Y29sb3JzPW9uZSA8PCBicHA7CiAgICAgICAgICAgICAgICAgICBpZiAoIUFjcXVpcmVJbWFnZUNvbG9ybWFwKGltYWdlLGltYWdlLT5jb2xvcnMsZXhjZXB0aW9uKSkKQEAgLTExMzAsNyArMTEzMCw3IEBAIHN0YXRpYyBJbWFnZSAqUmVhZFdQR0ltYWdlKGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgLyogcHJpbnRmKCJMb2FkIGRlZmF1bHQgY29sb3JtYXAgXG4iKTsgKi8KICAgICAgICAgICAgICAgICAgIGZvciAoaT0wOyAoaSA8IChpbnQpIGltYWdlLT5jb2xvcnMpICYmIChpIDwgMjU2KTsgaSsrKQotICAgICAgICAgICAgICAgICAgICB7CisgICAgICAgICAgICAgICAgICAgIHsgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICAgICBpbWFnZS0+Y29sb3JtYXBbaV0ucmVkPVNjYWxlQ2hhclRvUXVhbnR1bShXUEcxX1BhbGV0dGVbaV0uUmVkKTsKICAgICAgICAgICAgICAgICAgICAgICBpbWFnZS0+Y29sb3JtYXBbaV0uZ3JlZW49U2NhbGVDaGFyVG9RdWFudHVtKFdQRzFfUGFsZXR0ZVtpXS5HcmVlbik7CiAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2UtPmNvbG9ybWFwW2ldLmJsdWU9U2NhbGVDaGFyVG9RdWFudHVtKFdQRzFfUGFsZXR0ZVtpXS5CbHVlKTsKQEAgLTExNDQsNyArMTE0NCw3IEBAIHN0YXRpYyBJbWFnZSAqUmVhZFdQR0ltYWdlKGNvbnN0IEltYWdlSW5mbyAqaW1hZ2VfaW5mbywKICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLT5jb2xvcm1hcCwoc2l6ZV90KSAob25lIDw8IGJwcCksCiAgICAgICAgICAgICAgICAgICAgICAgICBzaXplb2YoKmltYWdlLT5jb2xvcm1hcCkpOwogICAgICAgICAgICAgICAgIH0KLQorICAgICAgICAgIAogICAgICAgICAgICAgICBpZiAoYnBwID09IDEpCiAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgaWYoaW1hZ2UtPmNvbG9ybWFwWzBdLnJlZD09MCAmJgpAQCAtMTE1OCw3ICsxMTU4LDcgQEAgc3RhdGljIEltYWdlICpSZWFkV1BHSW1hZ2UoY29uc3QgSW1hZ2VJbmZvICppbWFnZV9pbmZvLAogICAgICAgICAgICAgICAgICAgICAgICAgaW1hZ2UtPmNvbG9ybWFwWzFdLmdyZWVuID0KICAgICAgICAgICAgICAgICAgICAgICAgIGltYWdlLT5jb2xvcm1hcFsxXS5ibHVlID0gUXVhbnR1bVJhbmdlOwogICAgICAgICAgICAgICAgICAgICB9Ci0gICAgICAgICAgICAgICAgfQorICAgICAgICAgICAgICAgIH0gICAgICAKIAogICAgICAgICAgICAgICBpZihVbnBhY2tXUEdSYXN0ZXIoaW1hZ2UsYnBwLGV4Y2VwdGlvbikgPCAwKQogICAgICAgICAgICAgICAgIC8qIFRoZSByYXN0ZXIgY2Fubm90IGJlIHVucGFja2VkICovCkBAIC0xMTY4LDcgKzExNjgsNyBAQCBzdGF0aWMgSW1hZ2UgKlJlYWRXUEdJbWFnZShjb25zdCBJbWFnZUluZm8gKmltYWdlX2luZm8sCiAgICAgICAgICAgICAgICAgICAgIH0KIAogICAgICAgICAgICAgICBpZihSZWMuUmVjVHlwZT09MHgxNCAmJiBCaXRtYXBIZWFkZXIyLlJvdEFuZ2xlIT0wICYmICFpbWFnZV9pbmZvLT5waW5nKQotICAgICAgICAgICAgICAgIHsKKyAgICAgICAgICAgICAgICB7ICAKICAgICAgICAgICAgICAgICAgIC8qIGZsb3AgY29tbWFuZCAqLwogICAgICAgICAgICAgICAgICAgaWYoQml0bWFwSGVhZGVyMi5Sb3RBbmdsZSAmIDB4ODAwMCkKICAgICAgICAgICAgICAgICAgICAgewpAQCAtMTM2MCw3ICsxMzYwLDcgQEAgc3RhdGljIEltYWdlICpSZWFkV1BHSW1hZ2UoY29uc3QgSW1hZ2VJbmZvICppbWFnZV9pbmZvLAogICAgICAgICAgICAgICAgICAgICBpZiggVW5wYWNrV1BHMlJhc3RlcihpbWFnZSxicHAsZXhjZXB0aW9uKSA8IDApCiAgICAgICAgICAgICAgICAgICAgICAgZ290byBEZWNvbXByZXNzaW9uRmFpbGVkOwogICAgICAgICAgICAgICAgICAgICBicmVhazsKLSAgICAgICAgICAgICAgICAgIH0KKyAgICAgICAgICAgICAgICAgIH0gICAKICAgICAgICAgICAgICAgICB9CiAKICAgICAgICAgICAgICAgaWYoQ1RNWzBdWzBdPDAgJiYgIWltYWdlX2luZm8tPnBpbmcpCmRpZmYgLS1naXQgYS9jb2RlcnMveHBtLmMgYi9jb2RlcnMveHBtLmMKaW5kZXggMDIzZjU4YmMyLi4yNzM0YzFmZjUgMTAwNjQ0Ci0tLSBhL2NvZGVycy94cG0uYworKysgYi9jb2RlcnMveHBtLmMKQEAgLTM2Niw3ICszNjYsNiBAQCBzdGF0aWMgSW1hZ2UgKlJlYWRYUE1JbWFnZShjb25zdCBJbWFnZUluZm8gKmltYWdlX2luZm8sRXhjZXB0aW9uSW5mbyAqZXhjZXB0aW9uKQogICAgICh2b2lkICooKikodm9pZCAqKSkgTlVMTCk7CiAgIGlmIChBY3F1aXJlSW1hZ2VDb2xvcm1hcChpbWFnZSxpbWFnZS0+Y29sb3JzLGV4Y2VwdGlvbikgPT0gTWFnaWNrRmFsc2UpCiAgICAgewotICAgICAgeHBtX2NvbG9ycz1EZXN0cm95U3BsYXlUcmVlKHhwbV9jb2xvcnMpOwogICAgICAgeHBtX2J1ZmZlcj1EZXN0cm95U3RyaW5nKHhwbV9idWZmZXIpOwogICAgICAgVGhyb3dSZWFkZXJFeGNlcHRpb24oUmVzb3VyY2VMaW1pdEVycm9yLCJNZW1vcnlBbGxvY2F0aW9uRmFpbGVkIik7CiAgICAgfQpAQCAtNDMxLDExICs0MzAsNyBAQCBzdGF0aWMgSW1hZ2UgKlJlYWRYUE1JbWFnZShjb25zdCBJbWFnZUluZm8gKmltYWdlX2luZm8sRXhjZXB0aW9uSW5mbyAqZXhjZXB0aW9uKQogICAgICAgKi8KICAgICAgIHN0YXR1cz1TZXRJbWFnZUV4dGVudChpbWFnZSxpbWFnZS0+Y29sdW1ucyxpbWFnZS0+cm93cyxleGNlcHRpb24pOwogICAgICAgaWYgKHN0YXR1cyA9PSBNYWdpY2tGYWxzZSkKLSAgICAgICAgewotICAgICAgICAgIHhwbV9jb2xvcnM9RGVzdHJveVNwbGF5VHJlZSh4cG1fY29sb3JzKTsKLSAgICAgICAgICB4cG1fYnVmZmVyPURlc3Ryb3lTdHJpbmcoeHBtX2J1ZmZlcik7Ci0gICAgICAgICAgcmV0dXJuKERlc3Ryb3lJbWFnZUxpc3QoaW1hZ2UpKTsKLSAgICAgICAgfQorICAgICAgICByZXR1cm4oRGVzdHJveUltYWdlTGlzdChpbWFnZSkpOwogICAgICAgZm9yICh5PTA7IHkgPCAoc3NpemVfdCkgaW1hZ2UtPnJvd3M7IHkrKykKICAgICAgIHsKICAgICAgICAgcD1OZXh0WFBNTGluZShwKTsKZGlmZiAtLWdpdCBhL2NvbmZpZ3VyZSBiL2NvbmZpZ3VyZQppbmRleCBjMTc5NGZkMWYuLmM0YTJkM2RiNCAxMDA3NTUKLS0tIGEvY29uZmlndXJlCisrKyBiL2NvbmZpZ3VyZQpAQCAtNDU1OSw3ICs0NTU5LDcgQEAgTUFHSUNLX1BBVENITEVWRUxfVkVSU0lPTj0xMgogCiBNQUdJQ0tfVkVSU0lPTj03LjAuNy0xMgogCi1NQUdJQ0tfR0lUX1JFVklTSU9OPTIxNzg2OjBlZTQ0ZmNkYjoyMDE3MTEyNQorTUFHSUNLX0dJVF9SRVZJU0lPTj0yMTcxMTpiMDFkMjU4MWM6MjAxNzExMjAKIAogCiAjIFN1YnN0aXR1dGUgbGlicmFyeSB2ZXJzaW9uaW5nCg=="
  }
}