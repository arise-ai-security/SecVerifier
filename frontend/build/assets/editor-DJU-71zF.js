import{w as O}from"./with-props-CpQmc7fE.js";import{r as S,p as d,o as r}from"./chunk-BAXFHI7N-C1aCn8M0.js";import{a as L}from"./react-redux-bUW3E-1D.js";import{w as G}from"./index-Cn3G-Wx0.js";import{G as b}from"./iconBase-Byyvnogp.js";import{c as I}from"./utils-CsA7xLXy.js";import{u as N}from"./open-hands-axios-DmXtiBSx.js";import{O as A}from"./open-hands--YlJ3f3i.js";import{u as k}from"./conversation-context-C7l2I9sq.js";import{r as M}from"./retrieve-axios-error-message-CoJTAmT2.js";import{R as T}from"./agent-state-u5yf9HVO.js";import{I as x}from"./declaration-Be1JuYcO.js";import{u as V}from"./useTranslation-D6EhfAhY.js";import"./QueryClientProvider-DzZUh9st.js";import"./i18nInstance-CHFDjdcJ.js";function P(e){return b({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"},child:[]},{tag:"path",attr:{d:"M9 10h6"},child:[]},{tag:"path",attr:{d:"M12 13V7"},child:[]},{tag:"path",attr:{d:"M9 17h6"},child:[]}]})(e)}function U(e){return b({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"},child:[]},{tag:"path",attr:{d:"M14 2v4a2 2 0 0 0 2 2h4"},child:[]},{tag:"path",attr:{d:"M9 15h6"},child:[]}]})(e)}function W(e){return b({attr:{viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round"},child:[{tag:"path",attr:{d:"M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"},child:[]},{tag:"path",attr:{d:"M14 2v4a2 2 0 0 0 2 2h4"},child:[]},{tag:"path",attr:{d:"M9 15h6"},child:[]},{tag:"path",attr:{d:"M12 18v-6"},child:[]}]})(e)}const q=e=>{var i;switch((i=e.split(".").pop())==null?void 0:i.toLowerCase()){case"js":case"jsx":return"javascript";case"ts":case"tsx":return"typescript";case"py":return"python";case"html":return"html";case"css":return"css";case"json":return"json";case"md":return"markdown";case"yml":case"yaml":return"yaml";case"sh":case"bash":return"bash";case"dockerfile":return"dockerfile";case"rs":return"rust";case"go":return"go";case"java":return"java";case"cpp":case"cc":case"cxx":return"cpp";case"c":return"c";case"rb":return"ruby";case"php":return"php";case"sql":return"sql";default:return"text"}},B=e=>S.createElement("svg",{width:13,height:8,viewBox:"0 0 13 8",fill:"none",xmlns:"http://www.w3.org/2000/svg",...e},S.createElement("path",{fillRule:"evenodd",clipRule:"evenodd",d:"M0.259766 6.17427L6.26425 0.715628L12.2688 6.17427L11.2597 7.28418L6.26425 2.74282L1.26878 7.28418L0.259766 6.17427Z",fill:"currentColor"})),$=e=>{const{conversationId:t}=k();return N({queryKey:["file_diff",t,e.filePath,e.type],queryFn:()=>A.getGitChangeDiff(t,e.filePath),enabled:e.enabled,staleTime:1e3*60*5,gcTime:1e3*60*15})};function K({className:e}){return r.jsx("div",{className:"flex items-center justify-center",children:r.jsx("div",{className:I("animate-spin rounded-full border-4 border-gray-200 border-t-blue-500",e),role:"status","aria-label":"Loading"})})}const C={A:W,D:U,M:P,R:"Renamed",U:"Untracked"};function Z({path:e,type:t}){const[i,u]=d.useState(!0),[l,h]=d.useState(400),s=d.useRef(null),n=t==="A"||t==="U",o=t==="D",f=d.useMemo(()=>{if(t==="R"){const a=e.split(/\s+/).slice(1);return a[a.length-1]}return e},[e,t]),{data:m,isLoading:p,isSuccess:c,isRefetching:_}=$({filePath:f,type:t,enabled:!i}),v=d.useCallback(()=>{if(s.current){const a=s.current.getOriginalEditor(),g=s.current.getModifiedEditor();if(a&&g){const y=a.getContentHeight(),F=g.getContentHeight(),H=Math.max(y,F);h(H+20)}}},[]),D=a=>{s.current=a,v();const g=a.getOriginalEditor(),y=a.getModifiedEditor();g.onDidContentSizeChange(v),y.onDidContentSizeChange(v)},j=t==="U"?C.A:C[t];let w;if(typeof j=="string")w=r.jsx("span",{children:j});else{const a=j;w=r.jsx(a,{className:"w-5 h-5"})}const R=p||_;return r.jsxs("div",{"data-testid":"file-diff-viewer-outer",className:"w-full flex flex-col",children:[r.jsx("div",{className:I("flex justify-between items-center px-2.5 py-3.5 border border-neutral-600 rounded-xl hover:cursor-pointer",!i&&!p&&"border-b-0 rounded-b-none"),onClick:()=>u(a=>!a),children:r.jsxs("span",{className:"text-sm w-full text-content flex items-center gap-2",children:[R&&r.jsx(K,{className:"w-5 h-5"}),!R&&w,r.jsx("strong",{className:"w-full truncate",children:f}),r.jsx("button",{"data-testid":"collapse",type:"button",children:r.jsx(B,{className:I("w-4 h-4 transition-transform",i&&"transform rotate-180")})})]})}),c&&!i&&r.jsx("div",{className:"w-full border border-neutral-600 overflow-hidden",style:{height:`${l}px`},children:r.jsx(G,{"data-testid":"file-diff-viewer",className:"w-full h-full",language:q(f),original:n?"":m.original,modified:o?"":m.modified,theme:"vs-dark",onMount:D,options:{renderValidationDecorations:"off",readOnly:!0,renderSideBySide:!n&&!o,scrollBeyondLastLine:!1,minimap:{enabled:!1},hideUnchangedRegions:{enabled:!0},automaticLayout:!0,scrollbar:{alwaysConsumeMouseWheel:!1}}})})]})}const z=()=>{const{conversationId:e}=k(),[t,i]=d.useState([]),u=d.useRef(null),{curAgentState:l}=L(n=>n.agent),h=!T.includes(l),s=N({queryKey:["file_changes",e],queryFn:()=>A.getGitChanges(e),retry:!1,staleTime:1e3*60*5,gcTime:1e3*60*15,enabled:h,meta:{disableToast:!0}});return d.useEffect(()=>{if(s.data){const n=s.data;if(n!==u.current)if(u.current=n,Array.isArray(n)){const o=new Set(n.map(c=>c.path)),f=new Set(t.map(c=>c.path)),m=n.filter(c=>!f.has(c.path)),p=t.filter(c=>o.has(c.path));i([...m,...p])}else i([n])}},[s.data]),{data:t,isSuccess:s.isSuccess,isError:s.isError,error:s.error}},Q=/not a git repository/i;function E({children:e}){return r.jsx("div",{className:"w-full h-full flex items-center text-center justify-center text-2xl text-tertiary-light",children:e})}function J(){const{t:e}=V(),{data:t,isSuccess:i,isError:u,error:l}=z(),{curAgentState:h}=L(o=>o.agent),s=!T.includes(h),n=l&&Q.test(M(l));return r.jsxs("main",{className:"h-full overflow-y-scroll px-4 py-3 gap-3 flex flex-col",children:[!s&&r.jsx(E,{children:e(x.DIFF_VIEWER$WAITING_FOR_RUNTIME)}),!n&&l&&r.jsx(E,{children:M(l)}),n&&r.jsxs(E,{children:[e(x.DIFF_VIEWER$NOT_A_GIT_REPO),r.jsx("br",{}),e(x.DIFF_VIEWER$ASK_OH)]}),s&&!u&&(t==null?void 0:t.length)===0&&r.jsx(E,{children:e(x.DIFF_VIEWER$NO_CHANGES)}),i&&t.map(o=>r.jsx(Z,{path:o.path,type:o.status},o.path))]})}const fe=O(J);export{fe as default};
