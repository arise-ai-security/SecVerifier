import{j as e,r as x,R as S,w as Ee}from"./chunk-ZYFC6VSF-CV8XXl5-.js";import{u as le}from"./use-config-Cu-DTsjW.js";import{u as pe}from"./use-settings-Ds8Eg1n4.js";import{B as j,u as V}from"./brand-button-BwmgTwuO.js";import{u as he}from"./use-logout-DGDwoPfW.js";import{I as s}from"./declaration-CSyN0VgG.js";import{S as g}from"./settings-input-CBXw9VoS.js";import{u as E}from"./useTranslation-mdJfIcDH.js";import{T as U}from"./Trans-CWB6yLRR.js";import{K as B}from"./key-status-icon-DDppEOEs.js";import{a as F,d as ce}from"./custom-toast-handlers-BD_JVnrP.js";import{r as J}from"./retrieve-axios-error-message-CYr77e_f.js";import{I as ie,S as me}from"./input-skeleton-BoPFuPdN.js";import{S as re}from"./subtext-skeleton-DbJIaEED.js";import{u as q,o as D,f as ue}from"./open-hands-axios-BHmDa7Dt.js";import{S as fe}from"./secrets-service-D3it4Pvg.js";import{u as xe}from"./use-user-providers-DUJUMBCv.js";import{u as ge}from"./useQuery-BQp87qj0.js";import{M as Ne}from"./modal-backdrop-eyYAchCQ.js";import{M as Te}from"./modal-body-VF1Y6uTQ.js";import{B as Ae,a as _e}from"./base-modal-Cy52Bh8C.js";import"./open-hands-C0cV1FsE.js";import"./module-D8R257Cm.js";import"./mutation-CyON2C4n.js";import"./utils-ortCDxR2.js";import"./optional-tag-D6E6pm99.js";import"./i18nInstance-DBIXdvxg.js";import"./index-DuWOChOE.js";function be(){const{t}=E();return e.jsx("p",{"data-testid":"github-token-help-anchor",className:"text-xs",children:e.jsx(U,{i18nKey:s.GITHUB$TOKEN_HELP_TEXT,components:[e.jsx("a",{"aria-label":t(s.GIT$GITHUB_TOKEN_HELP_LINK),href:"https://github.com/settings/tokens/new?description=openhands-app&scopes=repo,user,workflow",target:"_blank",className:"underline underline-offset-2",rel:"noopener noreferrer"},"github-token-help-anchor-link"),e.jsx("a",{"aria-label":t(s.GIT$GITHUB_TOKEN_SEE_MORE_LINK),href:"https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/creating-a-personal-access-token",target:"_blank",className:"underline underline-offset-2",rel:"noopener noreferrer"},"github-token-help-anchor-link-2")]})})}function Ce({onChange:t,onGitHubHostChange:o,isGitHubTokenSet:i,name:c,githubHostSet:n}){const{t:a}=E();return e.jsxs("div",{className:"flex flex-col gap-6",children:[e.jsx(g,{testId:c,name:c,onChange:t,label:a(s.GITHUB$TOKEN_LABEL),type:"password",className:"w-full max-w-[680px]",placeholder:i?"<hidden>":"",startContent:i&&e.jsx(B,{testId:"gh-set-token-indicator",isSet:i})}),e.jsx(g,{onChange:o||(()=>{}),name:"github-host-input",testId:"github-host-input",label:a(s.GITHUB$HOST_LABEL),type:"text",className:"w-full max-w-[680px]",placeholder:"github.com",defaultValue:n||void 0,startContent:n&&n.trim()!==""&&e.jsx(B,{testId:"gh-set-host-indicator",isSet:!0})}),e.jsx(be,{})]})}function Ie(){const{t}=E();return e.jsx("p",{"data-testid":"gitlab-token-help-anchor",className:"text-xs",children:e.jsx(U,{i18nKey:s.GITLAB$TOKEN_HELP_TEXT,components:[e.jsx("a",{"aria-label":t(s.GIT$GITLAB_TOKEN_HELP_LINK),href:"https://gitlab.com/-/user_settings/personal_access_tokens?name=openhands-app&scopes=api,read_user,read_repository,write_repository",target:"_blank",className:"underline underline-offset-2",rel:"noopener noreferrer"},"gitlab-token-help-anchor-link"),e.jsx("a",{"aria-label":t(s.GIT$GITLAB_TOKEN_SEE_MORE_LINK),href:"https://docs.gitlab.com/user/profile/personal_access_tokens/",target:"_blank",className:"underline underline-offset-2",rel:"noopener noreferrer"},"gitlab-token-help-anchor-link-2")]})})}function ke({onChange:t,onGitLabHostChange:o,isGitLabTokenSet:i,name:c,gitlabHostSet:n}){const{t:a}=E();return e.jsxs("div",{className:"flex flex-col gap-6",children:[e.jsx(g,{testId:c,name:c,onChange:t,label:a(s.GITLAB$TOKEN_LABEL),type:"password",className:"w-full max-w-[680px]",placeholder:i?"<hidden>":"",startContent:i&&e.jsx(B,{testId:"gl-set-token-indicator",isSet:i})}),e.jsx(g,{onChange:o||(()=>{}),name:"gitlab-host-input",testId:"gitlab-host-input",label:a(s.GITLAB$HOST_LABEL),type:"text",className:"w-full max-w-[680px]",placeholder:"gitlab.com",defaultValue:n||void 0,startContent:n&&n.trim()!==""&&e.jsx(B,{testId:"gl-set-host-indicator",isSet:!0})}),e.jsx(Ie,{})]})}function Se(){const{t}=E();return e.jsx("p",{"data-testid":"bitbucket-token-help-anchor",className:"text-xs",children:e.jsx(U,{i18nKey:s.BITBUCKET$TOKEN_HELP_TEXT,components:[e.jsx("a",{"aria-label":t(s.GIT$BITBUCKET_TOKEN_HELP_LINK),href:"https://bitbucket.org/account/settings/app-passwords/new?scopes=repository:write,pullrequest:write,issue:write",target:"_blank",className:"underline underline-offset-2",rel:"noopener noreferrer"},"bitbucket-token-help-anchor-link"),e.jsx("a",{"aria-label":t(s.GIT$BITBUCKET_TOKEN_SEE_MORE_LINK),href:"https://support.atlassian.com/bitbucket-cloud/docs/app-passwords/",target:"_blank",className:"underline underline-offset-2",rel:"noopener noreferrer"},"bitbucket-token-help-anchor-link-2")]})})}function je({onChange:t,onBitbucketHostChange:o,isBitbucketTokenSet:i,name:c,bitbucketHostSet:n}){const{t:a}=E();return e.jsxs("div",{className:"flex flex-col gap-6",children:[e.jsx(g,{testId:c,name:c,onChange:t,label:a(s.BITBUCKET$TOKEN_LABEL),type:"password",className:"w-full max-w-[680px]",placeholder:i?"<hidden>":"username:app_password",startContent:i&&e.jsx(B,{testId:"bb-set-token-indicator",isSet:i})}),e.jsx(g,{onChange:o||(()=>{}),name:"bitbucket-host-input",testId:"bitbucket-host-input",label:a(s.BITBUCKET$HOST_LABEL),type:"text",className:"w-full max-w-[680px]",placeholder:"bitbucket.org",defaultValue:n||void 0,startContent:n&&n.trim()!==""&&e.jsx(B,{testId:"bb-set-host-indicator",isSet:!0})}),e.jsx(Se,{})]})}function Re({slug:t}){const{t:o}=E();return e.jsx("div",{"data-testid":"configure-github-repositories-button",className:"py-9",children:e.jsx(j,{type:"button",variant:"primary",className:"w-55",onClick:()=>window.open(`https://github.com/apps/${t}/installations/new`,"_blank","noreferrer noopener"),children:o(s.GITHUB$CONFIGURE_REPOS)})})}function Le(){const{t}=E();return e.jsx("div",{"data-testid":"install-slack-app-button",className:"py-9",children:e.jsx(j,{type:"button",variant:"primary",className:"w-55",onClick:()=>window.open("https://slack.com/oauth/v2/authorize?client_id=7477886716822.8729519890534&scope=app_mentions:read,channels:history,chat:write,groups:history,im:history,mpim:history,users:read&user_scope=","_blank","noreferrer noopener"),children:t(s.SLACK$INSTALL_APP)})})}function Oe(){return e.jsxs("div",{className:"px-11 py-9 flex flex-col gap-12",children:[e.jsxs("div",{className:"flex flex-col gap-6",children:[e.jsx(ie,{}),e.jsx(re,{})]}),e.jsxs("div",{className:"flex flex-col gap-6",children:[e.jsx(ie,{}),e.jsx(re,{})]})]})}const we=()=>{const t=q();return V({mutationFn:({providers:o})=>fe.addGitProvider(o),onSuccess:async()=>{await t.invalidateQueries({queryKey:["settings"]})},meta:{disableToast:!0}})};function Ge(t){return ge({queryKey:["integration-status",t],queryFn:async()=>{try{return(await D.get(`/integration/${t}/workspaces/link`)).data}catch(o){if(ue.isAxiosError(o)&&o.response?.status===404)return null;throw o}}})}function Me(t,{onSettled:o}){const i=q(),{t:c}=E();return V({mutationFn:async n=>{const a={workspace_name:n},p=await D.post(`/integration/${t}/workspaces/link`,a),{success:h,redirect:r,authorizationUrl:d}=p.data;if(h)if(r)if(d)window.location.href=d;else throw new Error("Could not get authorization URL from the server.");else window.location.reload();else throw new Error("Link integration failed");return p.data},onSuccess:()=>{i.invalidateQueries({queryKey:["integration-status",t]})},onError:n=>{const a=J(n);F(a||c(s.ERROR$GENERIC))},onSettled:o})}function ye(t,{onSettled:o}){const i=q(),{t:c}=E();return V({mutationFn:()=>D.post(`/integration/${t}/workspaces/unlink`),onSuccess:()=>{ce(c(s.SETTINGS$SAVED)),i.invalidateQueries({queryKey:["integration-status",t]})},onError:n=>{const a=J(n);F(a||c(s.ERROR$GENERIC))},onSettled:o})}function ve(t,{onSettled:o}){const i=q(),{t:c}=E();return V({mutationFn:async n=>{const a={workspace_name:n.workspace,webhook_secret:n.webhookSecret,svc_acc_email:n.serviceAccountEmail,svc_acc_api_key:n.serviceAccountApiKey,is_active:n.isActive},p=await D.post(`/integration/${t}/workspaces`,a),{success:h,redirect:r,authorizationUrl:d}=p.data;if(h)if(r)if(d)window.location.href=d;else throw new Error("Could not get authorization URL from the server.");else window.location.reload();else throw new Error("Configuration failed");return p.data},onSuccess:()=>{i.invalidateQueries({queryKey:["integration-status",t]})},onError:n=>{const a=J(n);F(a||c(s.ERROR$GENERIC))},onSettled:o})}function Be(t,{onSuccess:o,onError:i}){const{t:c}=E();return V({mutationFn:n=>{const a=n?`/${n}`:"";return D.get(`/integration/${t}/workspaces/validate${a}`)},onSuccess:o,onError:n=>{if(ue.isAxiosError(n)&&n.response?.status===404)i(n);else{const a=J(n);F(a||c(s.PROJECT_MANAGEMENT$VALIDATE_INTEGRATION_ERROR))}}})}function Pe({onClick:t,isDisabled:o,text:i,"data-testid":c}){const{t:n}=E();return e.jsx(j,{"data-testid":c,variant:"primary",onClick:t,isDisabled:o,type:"button",className:"w-30 min-w-20",children:i||n(s.PROJECT_MANAGEMENT$CONFIGURE_BUTTON_LABEL)})}function $e({isOpen:t,onClose:o,onConfirm:i,onLink:c,onUnlink:n,platformName:a,platform:p,integrationData:h}){const{t:r}=E(),[d,N]=x.useState(""),[b,O]=x.useState(""),[C,w]=x.useState(""),[I,G]=x.useState(""),[R,T]=x.useState(!0),[m,k]=x.useState(!1),f=h?.workspace,P=f?.editable??!1;S.useEffect(()=>{t&&f?(N(f.name),k(P)):t&&!f&&(N(""),k(!1))},[t,f,P]);const[A,M]=x.useState(null),[y,v]=x.useState(null),[$,K]=x.useState(null),[L,H]=x.useState(null),u=Be(p,{onSuccess:l=>{l.data.status==="active"?c(d.trim()):(k(!0),T(!0))},onError:l=>{l.response?.status,k(!0),T(!0)}}),ne=l=>{const _=/^[a-zA-Z0-9\-_.]*$/.test(l);return!_&&l.length>0?M(r(s.PROJECT_MANAGEMENT$WORKSPACE_NAME_VALIDATION_ERROR)):M(null),_},z=l=>{const _=/\s/.test(l);return v(_?r(s.PROJECT_MANAGEMENT$WEBHOOK_SECRET_NAME_VALIDATION_ERROR):null),!_},Q=l=>{const ae=/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(l)||l.length===0;return!ae&&l.length>0?K(r(s.PROJECT_MANAGEMENT$SVC_ACC_EMAIL_VALIDATION_ERROR)):K(null),ae},X=l=>{const _=/\s/.test(l);return H(_?r(s.PROJECT_MANAGEMENT$SVC_ACC_API_KEY_VALIDATION_ERROR):null),!_},Z=l=>{N(l),ne(l)},Y=l=>{O(l),z(l)},ee=l=>{w(l),Q(l)},oe=l=>{G(l),X(l)},W=()=>{N(""),O(""),w(""),G(""),T(!1),k(!1),M(null),v(null),K(null),H(null),o()};if(!t)return null;const te=()=>{m?i({workspace:d,webhookSecret:b,serviceAccountEmail:C,serviceAccountApiKey:I,isActive:R}):f||u.mutate(d.trim())},de=m?!d.trim()||!b.trim()||!C.trim()||!I.trim()||A!==null||y!==null||$!==null||L!==null||u.isPending:!d.trim()||A!==null||u.isPending;return e.jsx(Ne,{onClose:W,children:e.jsxs(Te,{className:"items-start border border-tertiary w-96",children:[e.jsx(Ae,{title:m?r(s.PROJECT_MANAGEMENT$CONFIGURE_MODAL_TITLE,{platform:a}):r(s.PROJECT_MANAGEMENT$LINK_CONFIRMATION_TITLE)}),e.jsx(_e,{children:m?e.jsx(U,{i18nKey:s.PROJECT_MANAGEMENT$CONFIGURE_MODAL_DESCRIPTION,components:{a:e.jsx("a",{href:"https://docs.all-hands.dev/usage/cloud/openhands-cloud",target:"_blank",rel:"noopener noreferrer",className:"text-blue-500 hover:underline",children:"Check the document for more information"}),b:e.jsx("b",{})}}):e.jsx("p",{className:"mt-4",children:e.jsx(U,{i18nKey:s.PROJECT_MANAGEMENT$IMPORTANT_WORKSPACE_INTEGRATION,components:{b:e.jsx("b",{}),a:e.jsx("a",{href:"https://docs.all-hands.dev/usage/cloud/openhands-cloud",target:"_blank",rel:"noopener noreferrer",className:"text-blue-500 underline",children:"Check the document for more information"})}})})}),e.jsxs("div",{className:"w-full flex flex-col gap-4 mt-4",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex gap-2 items-end",children:[e.jsx("div",{className:"flex-1",children:e.jsx(g,{label:r(s.PROJECT_MANAGEMENT$WORKSPACE_NAME_LABEL),placeholder:r(s.PROJECT_MANAGEMENT$WORKSPACE_NAME_PLACEHOLDER),value:d,onChange:Z,className:"w-full",type:"text",pattern:"^[a-zA-Z0-9\\-_.]*$",isDisabled:!!f})}),f&&n&&e.jsx(j,{variant:"secondary",onClick:n,"data-testid":"unlink-button",type:"button",className:"mb-0",children:r(s.PROJECT_MANAGEMENT$UNLINK_BUTTON_LABEL)})]}),A&&e.jsx("p",{className:"text-red-500 text-sm mt-2",children:A})]}),m&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx(g,{label:r(s.PROJECT_MANAGEMENT$WEBHOOK_SECRET_LABEL),placeholder:r(s.PROJECT_MANAGEMENT$WEBHOOK_SECRET_PLACEHOLDER),value:b,onChange:Y,className:"w-full",type:"password"}),y&&e.jsx("p",{className:"text-red-500 text-sm mt-2",children:y})]}),e.jsxs("div",{children:[e.jsx(g,{label:r(s.PROJECT_MANAGEMENT$SERVICE_ACCOUNT_EMAIL_LABEL),placeholder:r(s.PROJECT_MANAGEMENT$SERVICE_ACCOUNT_EMAIL_PLACEHOLDER),value:C,onChange:ee,className:"w-full",type:"email"}),$&&e.jsx("p",{className:"text-red-500 text-sm mt-2",children:$})]}),e.jsxs("div",{children:[e.jsx(g,{label:r(s.PROJECT_MANAGEMENT$SERVICE_ACCOUNT_API_LABEL),placeholder:r(s.PROJECT_MANAGEMENT$SERVICE_ACCOUNT_API_PLACEHOLDER),value:I,onChange:oe,className:"w-full",type:"password"}),L&&e.jsx("p",{className:"text-red-500 text-sm mt-2",children:L})]}),e.jsx("div",{className:"mt-4",children:e.jsx(me,{testId:"active-toggle",onToggle:T,isToggled:R,children:r(s.PROJECT_MANAGEMENT$ACTIVE_TOGGLE_LABEL)})})]})]}),e.jsxs("div",{className:"flex flex-col gap-2 w-full mt-4",children:[(!f||P)&&e.jsx(j,{variant:"primary",onClick:te,"data-testid":"connect-button",type:"button",className:"w-full",isDisabled:de,children:r(f&&m?s.PROJECT_MANAGEMENT$EDIT_BUTTON_LABEL:s.PROJECT_MANAGEMENT$CONNECT_BUTTON_LABEL)}),e.jsx(j,{variant:"secondary",onClick:W,"data-testid":"cancel-button",type:"button",className:"w-full",children:r(s.FEEDBACK$CANCEL_LABEL)})]})]})})}function se({platform:t,platformName:o,"data-testid":i}){const[c,n]=S.useState(!1),{t:a}=E(),{data:p,isLoading:h}=Ge(t),r=Me(t,{onSettled:()=>{n(!1)}}),d=ye(t,{onSettled:()=>{n(!1)}}),N=ve(t,{onSettled:()=>{n(!1)}}),b=()=>{n(!0)},O=m=>{r.mutate(m)},C=()=>{d.mutate()},w=m=>{N.mutate(m)},I=h||r.isPending||d.isPending||N.isPending,G=p?.status==="active",R=p?.workspace,T=a(G&&R?s.PROJECT_MANAGEMENT$EDIT_BUTTON_LABEL:s.PROJECT_MANAGEMENT$CONFIGURE_BUTTON_LABEL);return e.jsxs("div",{className:"flex items-center justify-between","data-testid":i,children:[e.jsx("span",{className:"font-medium",children:o}),e.jsx("div",{className:"flex items-center gap-6",children:e.jsx(Pe,{onClick:b,isDisabled:I,text:T,"data-testid":`${t}-configure-button`})}),e.jsx($e,{isOpen:c,onClose:()=>n(!1),onConfirm:w,onLink:O,onUnlink:C,platformName:o,platform:t,integrationData:p})]})}function Ke(){const{t}=E(),{data:o}=le();return e.jsxs("div",{className:"flex flex-col gap-4 w-1/4",children:[e.jsx("h3",{className:"text-xl font-medium text-white",children:t(s.PROJECT_MANAGEMENT$TITLE)}),e.jsxs("div",{className:"flex flex-col gap-4",children:[o?.FEATURE_FLAGS?.ENABLE_JIRA&&e.jsx(se,{platform:"jira",platformName:"Jira Cloud","data-testid":"jira-integration-row"}),o?.FEATURE_FLAGS?.ENABLE_JIRA_DC&&e.jsx(se,{platform:"jira-dc",platformName:"Jira Data Center","data-testid":"jira-dc-integration-row"}),o?.FEATURE_FLAGS?.ENABLE_LINEAR&&e.jsx(se,{platform:"linear",platformName:"Linear","data-testid":"linear-integration-row"})]})]})}function He(){const{t}=E(),{mutate:o,isPending:i}=we(),{mutate:c}=he(),{data:n,isLoading:a}=pe(),{providers:p}=xe(),{data:h}=le(),[r,d]=S.useState(!1),[N,b]=S.useState(!1),[O,C]=S.useState(!1),[w,I]=S.useState(!1),[G,R]=S.useState(!1),[T,m]=S.useState(!1),k=n?.PROVIDER_TOKENS_SET.github,f=n?.PROVIDER_TOKENS_SET.gitlab,P=n?.PROVIDER_TOKENS_SET.bitbucket,A=h?.APP_MODE==="saas",M=p.includes("github"),y=p.includes("gitlab"),v=p.includes("bitbucket"),$=async u=>{if(u.get("disconnect-tokens-button")!==null){c();return}const z=u.get("github-token-input")?.toString()||"",Q=u.get("gitlab-token-input")?.toString()||"",X=u.get("bitbucket-token-input")?.toString()||"",Z=u.get("github-host-input")?.toString()||"",Y=u.get("gitlab-host-input")?.toString()||"",ee=u.get("bitbucket-host-input")?.toString()||"";o({providers:{github:{token:z,host:Z},gitlab:{token:Q,host:Y},bitbucket:{token:X,host:ee}}},{onSuccess:()=>{ce(t(s.SETTINGS$SAVED))},onError:W=>{const te=J(W);F(te||t(s.ERROR$GENERIC))},onSettled:()=>{d(!1),b(!1),C(!1),I(!1),R(!1),m(!1)}})},K=!r&&!N&&!O&&!w&&!G&&!T,L=A&&h.APP_SLUG,H=h?.FEATURE_FLAGS?.ENABLE_JIRA||h?.FEATURE_FLAGS?.ENABLE_JIRA_DC||h?.FEATURE_FLAGS?.ENABLE_LINEAR;return e.jsxs("form",{"data-testid":"git-settings-screen",action:$,className:"flex flex-col h-full justify-between",children:[!a&&e.jsxs("div",{className:"p-9 flex flex-col",children:[L&&!a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"pb-1 flex flex-col",children:[e.jsx("h3",{className:"text-xl font-medium text-white",children:t(s.SETTINGS$GITHUB)}),e.jsx(Re,{slug:h.APP_SLUG})]}),e.jsx("div",{className:"w-1/2 border-b border-gray-200"})]}),L&&!a&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"pb-1 mt-6 flex flex-col",children:[e.jsx("h3",{className:"text-xl font-medium text-white",children:t(s.SETTINGS$SLACK)}),e.jsx(Le,{})]}),e.jsx("div",{className:"w-1/2 border-b border-gray-200"})]}),H&&!a&&e.jsx("div",{className:"mt-6",children:e.jsx(Ke,{})}),!A&&e.jsx(Ce,{name:"github-token-input",isGitHubTokenSet:M,onChange:u=>{d(!!u)},onGitHubHostChange:u=>{I(!!u)},githubHostSet:k}),!A&&e.jsx(ke,{name:"gitlab-token-input",isGitLabTokenSet:y,onChange:u=>{b(!!u)},onGitLabHostChange:u=>{R(!!u)},gitlabHostSet:f}),!A&&e.jsx(je,{name:"bitbucket-token-input",isBitbucketTokenSet:v,onChange:u=>{C(!!u)},onBitbucketHostChange:u=>{m(!!u)},bitbucketHostSet:P})]}),a&&e.jsx(Oe,{}),e.jsx("div",{className:"flex gap-6 p-6 justify-end border-t border-t-tertiary",children:!L&&e.jsxs(e.Fragment,{children:[e.jsx(j,{testId:"disconnect-tokens-button",name:"disconnect-tokens-button",type:"submit",variant:"secondary",isDisabled:!M&&!y&&!v,children:t(s.GIT$DISCONNECT_TOKENS)}),e.jsxs(j,{testId:"submit-button",type:"submit",variant:"primary",isDisabled:i||K,children:[!i&&t("SETTINGS$SAVE_CHANGES"),i&&t("SETTINGS$SAVING")]})]})})]})}const ft=Ee(He);export{ft as default};
