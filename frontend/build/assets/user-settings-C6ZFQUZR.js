import{w as g,r,j as e}from"./chunk-ZYFC6VSF-CV8XXl5-.js";import{u as M,o as _}from"./open-hands-axios-BHmDa7Dt.js";import{u as V}from"./use-settings-Ds8Eg1n4.js";import{d as f}from"./custom-toast-handlers-BD_JVnrP.js";import{u as p}from"./useTranslation-mdJfIcDH.js";import"./useQuery-BQp87qj0.js";import"./open-hands-C0cV1FsE.js";import"./module-D8R257Cm.js";import"./use-config-Cu-DTsjW.js";import"./index-DuWOChOE.js";import"./i18nInstance-DBIXdvxg.js";const L=/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;function w({email:s,onEmailChange:t,onSaveEmail:m,onResendVerification:E,isSaving:i,isResendingVerification:o,isEmailChanged:l,emailVerified:I,isEmailValid:c,children:u}){const{t:a}=p();return e.jsx("div",{className:"flex flex-col gap-4",children:e.jsxs("div",{className:"flex flex-col gap-2",children:[e.jsx("label",{className:"text-sm",children:a("SETTINGS$USER_EMAIL")}),e.jsx("div",{className:"flex items-center gap-3",children:e.jsx("input",{type:"email",value:s,onChange:t,className:`text-base text-white p-2 bg-base-tertiary rounded-sm border ${l&&!c?"border-red-500":"border-tertiary"} flex-grow`,placeholder:a("SETTINGS$USER_EMAIL_LOADING"),"data-testid":"email-input"})}),l&&!c&&e.jsx("div",{className:"text-red-500 text-sm mt-1","data-testid":"email-validation-error",children:a("SETTINGS$INVALID_EMAIL_FORMAT")}),e.jsxs("div",{className:"flex items-center gap-3 mt-2",children:[e.jsx("button",{type:"button",onClick:m,disabled:!l||i||!c,className:"px-4 py-2 rounded-sm bg-primary text-white hover:opacity-80 disabled:opacity-30 disabled:cursor-not-allowed disabled:text-[#0D0F11]","data-testid":"save-email-button",children:a(i?"SETTINGS$SAVING":"SETTINGS$SAVE")}),I===!1&&e.jsx("button",{type:"button",onClick:E,disabled:o,className:"px-4 py-2 rounded-sm bg-primary text-white hover:opacity-80 disabled:opacity-30 disabled:cursor-not-allowed disabled:text-[#0D0F11]","data-testid":"resend-verification-button",children:a(o?"SETTINGS$SENDING":"SETTINGS$RESEND_VERIFICATION")})]}),u]})})}function j(){const{t:s}=p();return e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-sm mt-4",role:"alert",children:[e.jsx("p",{className:"font-bold",children:s("SETTINGS$EMAIL_VERIFICATION_REQUIRED")}),e.jsx("p",{className:"text-sm",children:s("SETTINGS$EMAIL_VERIFICATION_RESTRICTION_MESSAGE")})]})}function C(){const{t:s}=p(),{data:t,isLoading:m,refetch:E}=V(),[i,o]=r.useState(""),[l,I]=r.useState(""),[c,u]=r.useState(!1),[a,x]=r.useState(!1),[N,T]=r.useState(!0),S=M(),n=r.useRef(null),A=r.useRef(void 0);r.useEffect(()=>{t?.EMAIL&&(o(t.EMAIL),I(t.EMAIL),T(L.test(t.EMAIL)))},[t?.EMAIL]),r.useEffect(()=>(n.current&&(window.clearInterval(n.current),n.current=null),A.current===!1&&t?.EMAIL_VERIFIED===!0&&(f(s("SETTINGS$EMAIL_VERIFIED_SUCCESSFULLY")),setTimeout(()=>{S.invalidateQueries({queryKey:["settings"]})},2e3)),A.current=t?.EMAIL_VERIFIED,t?.EMAIL_VERIFIED===!1&&(n.current=window.setInterval(()=>{E()},5e3)),()=>{n.current&&(window.clearInterval(n.current),n.current=null)}),[t?.EMAIL_VERIFIED,E,S,s]);const R=d=>{const h=d.target.value;o(h),T(L.test(h))},y=async()=>{if(!(i===l||!N))try{u(!0),await _.post("/api/email",{email:i},{withCredentials:!0}),I(i),f(s("SETTINGS$EMAIL_SAVED_SUCCESSFULLY")),S.invalidateQueries({queryKey:["settings"]})}catch(d){console.error(s("SETTINGS$FAILED_TO_SAVE_EMAIL"),d)}finally{u(!1)}},b=async()=>{try{x(!0),await _.put("/api/email/verify",{},{withCredentials:!0}),f(s("SETTINGS$VERIFICATION_EMAIL_SENT"))}catch(d){console.error(s("SETTINGS$FAILED_TO_RESEND_VERIFICATION"),d)}finally{x(!1)}},v=i!==l;return e.jsx("div",{"data-testid":"user-settings-screen",className:"flex flex-col h-full",children:e.jsx("div",{className:"p-9 flex flex-col gap-6",children:m?e.jsx("div",{className:"animate-pulse h-8 w-64 bg-tertiary rounded-sm"}):e.jsx(w,{email:i,onEmailChange:R,onSaveEmail:y,onResendVerification:b,isSaving:c,isResendingVerification:a,isEmailChanged:v,emailVerified:t?.EMAIL_VERIFIED,isEmailValid:N,children:t?.EMAIL_VERIFIED===!1&&e.jsx(j,{})})})})}const K=g(C);export{K as default};
